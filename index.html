<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discipline Management System</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f0f2f5; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { color: #1a73e8; border-bottom: 2px solid #e8f0fe; padding-bottom: 15px; }
        
        /* Input Layout */
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 6px; flex: 1; }
        button { padding: 10px 20px; background-color: #1a73e8; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #1557b0; }

        /* Search Bar */
        #searchBox { width: 100%; margin-bottom: 20px; padding: 12px; border: 2px solid #e8f0fe; border-radius: 6px; box-sizing: border-box; font-size: 16px; }

        /* Table */
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 15px; border-bottom: 1px solid #eee; text-align: left; }
        th { background-color: #f8f9fa; color: #5f6368; text-transform: uppercase; font-size: 12px; }
        
        /* Auto-Counter Highlight */
        .warning-row { background-color: #fdf2f2 !important; color: #d93025; font-weight: bold; }
        .badge { padding: 4px 8px; border-radius: 4px; background: #e8f0fe; color: #1967d2; }
        .warning-row .badge { background: #d93025; color: white; }

        .delete-btn { background-color: #ea4335; font-size: 12px; padding: 6px 12px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Student Discipline Dashboard</h2>

    <div class="input-group">
        <input type="text" id="stuName" placeholder="Full Name">
        <input type="text" id="stuClass" placeholder="Class">
        <input type="text" id="violation" placeholder="Offence Description">
        <button onclick="submitRecord()">Key-in Record</button>
    </div>

    <input type="text" id="searchBox" onkeyup="filterRecords()" placeholder="ðŸ” Quick search by name or class...">

    <table>
        <thead>
            <tr>
                <th>Student Name</th>
                <th>Class</th>
                <th>Latest Offence</th>
                <th>Total Counts</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="recordBody">
            </tbody>
    </table>
</div>

<script type="module">
    // æ³¨æ„ï¼šCDN æ–¹å¼éœ€è¦ä»Ž https://www.gstatic.com å¯¼å…¥
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, where, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ä½ çš„é…ç½®å·²ç»å¡«å¥½
    const firebaseConfig = {
        apiKey: "AIzaSyCqY9ADs8oy1Uvh3-7eVCQLYfyTijm8lo4",
        authDomain: "bdpsemsira-5c274.firebaseapp.com",
        projectId: "bdpsemsira-5c274",
        storageBucket: "bdpsemsira-5c274.firebasestorage.app",
        messagingSenderId: "176946808975",
        appId: "1:176946808975:web:ef7447a11bb57fe71b88fa",
        measurementId: "G-NS4NJPK1EB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "students");

    // 1. æäº¤é€»è¾‘ï¼ˆå«è‡ªåŠ¨è®¡æ•°ï¼‰
    window.submitRecord = async () => {
        const name = document.getElementById('stuName').value.trim();
        const className = document.getElementById('stuClass').value.trim();
        const offence = document.getElementById('violation').value.trim();

        if (!name || !className) return alert("Please enter Name and Class");

        // æœç´¢æ•°æ®åº“ä¸­æ˜¯å¦å·²æœ‰è¯¥å­¦ç”Ÿ
        const q = query(colRef, where("name", "==", name));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
            // å¦‚æžœå­¦ç”Ÿå·²å­˜åœ¨ï¼Œå¢žåŠ è®¡æ•°å¹¶æ›´æ–°é”™è¯¯ä¿¡æ¯
            const studentDoc = querySnapshot.docs[0];
            await updateDoc(doc(db, "students", studentDoc.id), {
                offence: offence,
                counts: increment(1),
                lastUpdated: new Date()
            });
        } else {
            // æ–°å­¦ç”Ÿï¼Œåˆå§‹è®¡æ•°ä¸º 1
            await addDoc(colRef, {
                name: name,
                class: className,
                offence: offence,
                counts: 1,
                lastUpdated: new Date()
            });
        }

        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('stuName').value = "";
        document.getElementById('violation').value = "";
    };

    // 2. å®žæ—¶ç›‘å¬æ•°æ®åº“å¹¶åœ¨è¡¨æ ¼å±•ç¤º
    onSnapshot(colRef, (snapshot) => {
        let rows = "";
        snapshot.docs.forEach(docData => {
            const data = docData.data();
            const id = docData.id;
            // è‡ªåŠ¨è®¡æ•°å™¨é€»è¾‘ï¼šçŠ¯é”™ 3 æ¬¡æˆ–ä»¥ä¸Šæ˜¾ç¤ºè­¦å‘Šè‰²
            const rowStyle = data.counts >= 3 ? "warning-row" : "";
            
            rows += `
                <tr class="${rowStyle}">
                    <td>${data.name}</td>
                    <td>${data.class}</td>
                    <td>${data.offence}</td>
                    <td><span class="badge">${data.counts} Times</span></td>
                    <td><button class="delete-btn" onclick="deleteRecord('${id}')">Delete</button></td>
                </tr>
            `;
        });
        document.getElementById('recordBody').innerHTML = rows;
    });

    // 3. åˆ é™¤åŠŸèƒ½
    window.deleteRecord = async (id) => {
        if(confirm("Are you sure to delete this student's data?")) {
            await deleteDoc(doc(db, "students", id));
        }
    };

    // 4. æœç´¢è¿‡æ»¤é€»è¾‘
    window.filterRecords = () => {
        const term = document.getElementById('searchBox').value.toLowerCase();
        const rows = document.querySelectorAll('#recordBody tr');
        rows.forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(term) ? "" : "none";
        });
    };
</script>

</body>
</html>
