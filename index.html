<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discipline Management System</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { color: #333; border-bottom: 2px solid #333; padding-bottom: 10px; }
        
        /* Form Styling */
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; flex: 1; min-width: 150px; }
        button { padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #218838; }

        /* Search Bar */
        #searchBox { width: 100%; margin-bottom: 15px; background-color: #fffde7; border: 1px solid #ffe082; }

        /* Table Styling */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #343a40; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        
        /* Warning Logic */
        .warning { background-color: #ffcccc !important; font-weight: bold; color: #b71c1c; }
        .delete-btn { background-color: #dc3545; padding: 5px 10px; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Student Discipline Records</h2>

    <div class="input-group">
        <input type="text" id="stuName" placeholder="Student Name (Full Name)">
        <input type="text" id="stuClass" placeholder="Class (e.g. 3S1)">
        <input type="text" id="violation" placeholder="Offence (e.g. Late)">
        <button onclick="submitRecord()">Add Record</button>
    </div>

    <input type="text" id="searchBox" onkeyup="filterRecords()" placeholder="Search by name or class...">

    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Class</th>
                <th>Latest Offence</th>
                <th>Total Counts</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="recordBody">
            </tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, where, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // TODO: Replace with YOUR Firebase project configuration
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "YOUR_ID",
        appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "discipline_records");

    // --- FUNCTION: Submit or Update Record ---
    window.submitRecord = async () => {
        const name = document.getElementById('stuName').value.trim();
        const className = document.getElementById('stuClass').value.trim();
        const offence = document.getElementById('violation').value.trim();

        if (name === "" || className === "") return alert("Please fill in Name and Class");

        // Check if student already exists
        const q = query(colRef, where("name", "==", name));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
            // Update existing student
            const existingDoc = querySnapshot.docs[0];
            await updateDoc(doc(db, "discipline_records", existingDoc.id), {
                offence: offence,
                counts: increment(1)
            });
        } else {
            // Add new student
            await addDoc(colRef, {
                name: name,
                class: className,
                offence: offence,
                counts: 1
            });
        }
        
        // Clear inputs
        document.getElementById('stuName').value = "";
        document.getElementById('violation').value = "";
    };

    // --- FUNCTION: Real-time Listener to Display Data ---
    onSnapshot(colRef, (snapshot) => {
        let tableHtml = "";
        snapshot.docs.forEach(docData => {
            const data = docData.data();
            const id = docData.id;
            // Highlight in red if counts >= 3
            const rowClass = data.counts >= 3 ? "warning" : "";
            
            tableHtml += `
                <tr class="${rowClass}">
                    <td>${data.name}</td>
                    <td>${data.class}</td>
                    <td>${data.offence}</td>
                    <td>${data.counts}</td>
                    <td><button class="delete-btn" onclick="deleteRecord('${id}')">Delete</button></td>
                </tr>
            `;
        });
        document.getElementById('recordBody').innerHTML = tableHtml;
    });

    // --- FUNCTION: Delete Record ---
    window.deleteRecord = async (id) => {
        if(confirm("Are you sure you want to delete this record?")) {
            await deleteDoc(doc(db, "discipline_records", id));
        }
    };

    // --- FUNCTION: Frontend Search Filter ---
    window.filterRecords = () => {
        const searchValue = document.getElementById('searchBox').value.toLowerCase();
        const rows = document.querySelectorAll('#recordBody tr');
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(searchValue) ? "" : "none";
        });
    };
</script>

</body>
</html>
