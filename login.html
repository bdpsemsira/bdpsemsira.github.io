<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMKSS Security Pro</title>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --orange: #e67e22; --dark: #0d0d0d; --gray: #1a1a1a; }
        body { margin: 0; background: var(--dark); color: white; font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; display: flex; justify-content: center; align-items: center; }
        
        .glass-card { 
            background: var(--gray); padding: 30px; border-radius: 20px; width: 340px; 
            border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center;
        }

        /* 扫描窗口优化：增加科技感圆环 */
        #scanner-container { 
            display: none; position: relative; width: 220px; height: 220px; 
            margin: 0 auto 20px; border-radius: 50%; border: 2px solid #333; overflow: hidden;
        }
        #scanner-container.active { border-color: var(--orange); box-shadow: 0 0 15px var(--orange); }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: var(--orange); box-shadow: 0 0 10px var(--orange);
            animation: scan 2s linear infinite; display: none;
        }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        .btn { 
            width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 600; 
            cursor: pointer; transition: 0.3s; margin-top: 10px;
        }
        .btn-primary { background: var(--orange); color: white; }
        .btn-primary:disabled { background: #333; color: #666; cursor: not-allowed; }

        #msg { margin-top: 15px; font-size: 13px; color: #888; }
    </style>
</head>
<body>

<div class="glass-card">
    <h3 style="margin: 0 0 5px; color: var(--orange);">SMKSS SECURITY</h3>
    <p style="font-size: 11px; color: #555; margin-bottom: 20px;">v6.0 ENHANCED ENGINE</p>

    <div id="scanner-container">
        <video id="video" autoplay muted playsinline></video>
        <div class="scan-line" id="line"></div>
    </div>

    <button id="mainBtn" class="btn btn-primary" onclick="initScan()" disabled>SYNCING DATA...</button>
    <div id="msg">Initializing AI Systems...</div>
</div>

<script>
    const GITHUB_URL = "https://raw.githubusercontent.com/bdpsemsira/bdpsemsira.github.io/main/keys.txt";
    let faceMatcher = null;

    // 优化 1: 采用 Promise.all 并行加载，大幅缩短等待时间
    window.onload = async () => {
        try {
            await Promise.all([
                faceapi.nets.ssdMobilenetv1.loadFromUri('./model'),
                faceapi.nets.faceLandmark68Net.loadFromUri('./model'),
                faceapi.nets.faceRecognitionNet.loadFromUri('./model')
            ]);
            await loadDB();
        } catch (e) {
            log("System Error", "red");
        }
    };

    // 优化 2: 强力正则解析，无视 keys.txt 里的任何杂质符号
    async function loadDB() {
        try {
            const res = await fetch(`${GITHUB_URL}?t=${Date.now()}`);
            const text = await res.text();
            
            const lines = text.split('\n');
            const descriptors = [];

            lines.forEach(line => {
                // 正则表达式直接匹配 [数字, 数字...] 部分
                const nameMatch = line.match(/^[^:]+/);
                const arrayMatch = line.match(/\[(.*?)\]/);

                if (nameMatch && arrayMatch) {
                    try {
                        const name = nameMatch[0].trim();
                        const vec = new Float32Array(JSON.parse(`[${arrayMatch[1]}]`));
                        descriptors.push(new faceapi.LabeledFaceDescriptors(name, [vec]));
                    } catch (err) { console.warn("Parse skip"); }
                }
            });

            if (descriptors.length > 0) {
                // 优化 3: 适当放宽阈值到 0.52，让识别更“大众化”一点，不至于稍微侧头就失败
                faceMatcher = new faceapi.FaceMatcher(descriptors, 0.52);
                const btn = document.getElementById('mainBtn');
                btn.disabled = false;
                btn.innerText = "START BIO-SCAN";
                log("System Ready");
            } else {
                log("Database Empty", "red");
            }
        } catch (e) { log("Network Error", "red"); }
    }

    async function initScan() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            const v = document.getElementById('video');
            v.srcObject = stream;
            
            document.getElementById('scanner-container').style.display = 'block';
            document.getElementById('scanner-container').classList.add('active');
            document.getElementById('line').style.display = 'block';
            log("Scanning...");

            const loop = async () => {
                const detect = await faceapi.detectSingleFace(v).withFaceLandmarks().withFaceDescriptor();
                
                if (detect) {
                    const match = faceMatcher.findBestMatch(detect.descriptor);
                    // 优化 4: 控制台只显示最终判定结果，减轻渲染压力
                    console.log(`%c Detected: ${match.label}`, 'color: #e67e22');

                    if (match.label !== 'unknown') {
                        log(`Welcome, ${match.label}`, "#2ecc71");
                        // 识别成功反馈
                        setTimeout(() => {
                            sessionStorage.setItem('access_granted', 'true');
                            window.location.href = "sks_panel_982x.html";
                        }, 500);
                        return;
                    }
                }
                requestAnimationFrame(loop);
            };
            loop();
        } catch (e) { log("Camera Access Denied", "red"); }
    }

    function log(t, color = "#888") {
        const m = document.getElementById('msg');
        m.innerText = t;
        m.style.color = color;
    }
</script>
</body>
</html>
