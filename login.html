<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Security Terminal | SMKSS</title>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary: #e67e22; --bg: #0a0a0a; --card: #181818; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Courier New', monospace; height: 100vh; display: flex; justify-content: center; align-items: center; }
        .login-card { background: var(--card); padding: 30px; border-radius: 15px; width: 350px; text-align: center; border: 1px solid #333; box-shadow: 0 0 20px rgba(230,126,34,0.2); }
        #face-area { display: none; width: 100%; height: 250px; background: #000; border-radius: 10px; margin: 15px 0; border: 1px solid var(--primary); }
        video { width: 100%; height: 100%; object-fit: cover; }
        .input-group input { width: 100%; padding: 12px; margin: 5px 0; background: #000; border: 1px solid #444; color: #fff; box-sizing: border-box; }
        button { width: 100%; padding: 12px; margin-top: 10px; cursor: pointer; border: none; font-weight: bold; }
        .btn-face { background: #222; color: var(--primary); border: 1px solid var(--primary); }
        #status-msg { margin-top: 15px; font-size: 13px; letter-spacing: 1px; }
        .loading { color: var(--primary); }
        .success { color: #2ecc71; }
        .error { color: #e74c3c; }
    </style>
</head>
<body>

<div class="login-card">
    <h2 style="color:var(--primary); margin-top:0;">BIO-SCAN V5.1</h2>
    <div id="face-area"><video id="video" autoplay muted playsinline></video></div>
    
    <div class="input-group">
        <input type="text" id="username" placeholder="USER ID">
        <input type="password" id="passkey" placeholder="PASS KEY">
    </div>
    
    <button class="btn-face" onclick="startSecureScan()">INITIATE FACE SCAN</button>
    <div id="status-msg">SYSTEM STANDBY</div>
</div>

<script>
    const REPO_OWNER = "bdpsemsira"; 
    const REPO_NAME = "bdpsemsira.github.io"; 
    const KEY_FILE_PATH = "keys.txt"; 
    const TARGET_PAGE = 'sks_panel_982x.html'; 

    let faceMatcher = null;

    // 1. 页面加载即初始化模型
    window.onload = async () => {
        updateMsg("LOADING AI MODELS...", "loading");
        try {
            await faceapi.nets.ssdMobilenetv1.loadFromUri('./model');
            await faceapi.nets.faceLandmark68Net.loadFromUri('./model');
            await faceapi.nets.faceRecognitionNet.loadFromUri('./model');
            // 立即加载数据库
            await refreshUserDatabase();
        } catch (e) {
            updateMsg("MODEL LOAD ERROR", "error");
        }
    };

    // 2. 核心：全量加载数据库，防止卡在第一个人
    async function refreshUserDatabase() {
        try {
            const res = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${KEY_FILE_PATH}?t=${Date.now()}`);
            const text = await res.text();
            
            // 使用更健壮的正则分割和清洗数据
            const lines = text.split(/\r?\n/).filter(line => line.includes('['));
            const labeledDescriptors = [];

            for (let line of lines) {
                try {
                    // 彻底清除干扰符
                    const cleanLine = line.replace(/[\]\。]/g, "").trim();
                    const parts = cleanLine.split(':');
                    
                    if (parts.length < 3) continue;

                    const name = parts[0].trim();
                    const rawVector = parts[2].trim();
                    
                    // 尝试解析 JSON 数组
                    const vectorArray = JSON.parse(rawVector);
                    labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [new Float32Array(vectorArray)]));
                    console.log(`[Database] Loaded user: ${name}`);
                } catch (err) {
                    console.warn(`[Database] Failed to parse a line: ${line.substring(0,20)}...`);
                }
            }

            if (labeledDescriptors.length > 0) {
                // 创建匹配器，0.5 是容错率
                faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.5);
                updateMsg("DATABASE READY", "success");
            } else {
                updateMsg("DATABASE EMPTY", "error");
            }
        } catch (e) {
            updateMsg("NETWORK ERROR", "error");
        }
    }

    // 3. 启动扫描
    async function startSecureScan() {
        if (!faceMatcher) {
            await refreshUserDatabase();
            if (!faceMatcher) return;
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            const videoEl = document.getElementById('video');
            videoEl.srcObject = stream;
            document.getElementById('face-area').style.display = 'block';
            updateMsg("SCANNING...", "loading");

            const scanInterval = setInterval(async () => {
                const detection = await faceapi.detectSingleFace(videoEl).withFaceLandmarks().withFaceDescriptor();
                
                if (detection) {
                    // 核心逻辑：在所有人里找最像的一个
                    const match = faceMatcher.findBestMatch(detection.descriptor);
                    
                    // 打印当前系统看到的结果
                    console.log(`Target identified as: ${match.label} | Confid: ${(1 - match.distance).toFixed(2)}`);

                    if (match.label !== 'unknown' && match.distance < 0.45) {
                        clearInterval(scanInterval);
                        if (videoEl.srcObject) videoEl.srcObject.getTracks().forEach(t => t.stop());
                        document.getElementById('face-area').style.display = 'none';
                        
                        updateMsg(`ACCESS GRANTED: ${match.label}`, "success");
                        login(match.label);
                    } else {
                        // 如果识别出是 ZAKWAN 但距离太远，会显示在这里
                        updateMsg(`ID: ${match.label} (UNVERIFIED)`, "loading");
                    }
                }
            }, 600);
        } catch (err) {
            updateMsg("CAMERA ERROR", "error");
        }
    }

    function login(user) {
        sessionStorage.setItem('access_granted', 'true');
        sessionStorage.setItem('admin_name', user);
        setTimeout(() => window.location.replace(TARGET_PAGE), 1000);
    }

    function updateMsg(txt, cls) {
        const el = document.getElementById('status-msg');
        el.innerText = txt;
        el.className = cls;
    }
</script>
</body>
</html>
