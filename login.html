<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMKSS Security v5.5</title>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary: #e67e22; --bg: #0a0a0a; --card: #181818; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .info-header { position: absolute; top: 20px; right: 20px; text-align: right; font-size: 12px; font-family: monospace; z-index: 100; }
        #top-op { color: #888; } #top-status { color: var(--primary); font-weight: bold; }
        .login-card { background: var(--card); padding: 40px; border-radius: 24px; width: 360px; text-align: center; border: 1px solid #222; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .logo { width: 80px; margin-bottom: 10px; filter: drop-shadow(0 0 10px rgba(230, 126, 34, 0.4)); }
        #face-area { display: none; width: 100%; height: 240px; background: #000; border-radius: 12px; margin-bottom: 20px; border: 2px solid var(--primary); overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .btn-face { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid var(--primary); background: #222; color: var(--primary); font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-face:disabled { border-color: #444; color: #444; cursor: not-allowed; }
        #status-msg { margin-top: 15px; font-size: 12px; font-weight: bold; min-height: 18px; }
        .loading { color: var(--primary); } .success { color: #2ecc71; } .error { color: #ff4d4d; }
    </style>
</head>
<body>

<div class="info-header">
    <div id="top-op">Operator: Guest</div>
    <div id="top-status">Status: Standby</div>
</div>

<div class="login-card">
    <img src="semsira.png" alt="Logo" class="logo">
    <h2 style="color:var(--primary); margin:0;">DASHBOARD</h2>
    <p style="font-size: 10px; color:#555; margin-bottom:15px;">Secure Access v5.5</p>

    <div id="face-area"><video id="video" autoplay muted playsinline></video></div>
    
    <button type="button" id="scanBtn" class="btn-face" onclick="startSecureScan()" disabled>WAITING FOR DATABASE...</button>
    <div id="status-msg">INITIALIZING AI...</div>
</div>

<script>
    const REPO_OWNER = "bdpsemsira"; 
    const REPO_NAME = "bdpsemsira.github.io"; 
    const KEY_FILE_PATH = "keys.txt"; 
    const TARGET_PAGE = 'sks_panel_982x.html'; 

    let faceMatcher = null;
    let scanActive = false;

    // 1. 初始化入口
    window.onload = async () => {
        try {
            updateStatus("Guest", "Loading Models...", "loading");
            // 并行加载模型
            await Promise.all([
                faceapi.nets.ssdMobilenetv1.loadFromUri('./model'),
                faceapi.nets.faceLandmark68Net.loadFromUri('./model'),
                faceapi.nets.faceRecognitionNet.loadFromUri('./model')
            ]);
            
            updateStatus("Guest", "Syncing Database...", "loading");
            const success = await loadDatabase();
            
            if (success) {
                updateStatus("Guest", "System Online", "success");
                const btn = document.getElementById('scanBtn');
                btn.disabled = false;
                btn.innerText = "START BIOMETRIC SCAN";
            } else {
                updateStatus("Guest", "Database Empty", "error");
                document.getElementById('scanBtn').innerText = "DATABASE ERROR";
            }
        } catch (e) {
            updateStatus("Guest", "Init Failed", "error");
            console.error("Initialization Error:", e);
        }
    };

    // 2. 加载并解析数据库 (防止 findBestMatch of null)
    async function loadDatabase() {
        try {
            const res = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${KEY_FILE_PATH}?t=${Date.now()}`);
            if (!res.ok) throw new Error("Fetch failed");
            
            const text = await res.text();
            const lines = text.split(/\r?\n/).filter(line => line.includes('[') && line.includes(':'));
            const labeledDescriptors = [];

            for (let line of lines) {
                try {
                    // 彻底清理格式
                    const cleanLine = line.replace(/[\]\。]/g, "").trim();
                    const parts = cleanLine.split(':');
                    if (parts.length < 3) continue;

                    const name = parts[0].trim();
                    const vectorData = JSON.parse(parts[2].trim());
                    const vector = new Float32Array(vectorData);
                    
                    labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [vector]));
                    console.log("Successfully loaded user:", name);
                } catch (err) {
                    console.error("Line parse error:", line.substring(0, 20));
                }
            }

            if (labeledDescriptors.length > 0) {
                // 阈值设为 0.6 方便识别
                faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
                return true;
            }
        } catch (e) {
            console.error("Load Database Error:", e);
        }
        return false;
    }

    // 3. 扫描逻辑
    async function startSecureScan() {
        if (!faceMatcher) {
            alert("Database not ready!");
            return;
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            const video = document.getElementById('video');
            video.srcObject = stream;
            document.getElementById('face-area').style.display = 'block';
            scanActive = true;
            updateStatus("Scanning", "Looking for face...", "loading");

            const runDetection = async () => {
                if (!scanActive) return;

                const detection = await faceapi.detectSingleFace(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.4 }))
                                             .withFaceLandmarks()
                                             .withFaceDescriptor();
                
                if (detection) {
                    // 此时 faceMatcher 保证不为 null
                    const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                    console.log("Match Result:", bestMatch.toString());

                    if (bestMatch.label !== 'unknown' && bestMatch.distance < 0.5) {
                        updateStatus(bestMatch.label, "Success", "success");
                        stopCamera();
                        sessionStorage.setItem('access_granted', 'true');
                        sessionStorage.setItem('admin_name', bestMatch.label);
                        setTimeout(() => window.location.replace(TARGET_PAGE), 800);
                        return;
                    } else {
                        updateStatus("Guest", `Identity: ${bestMatch.label}`, "loading");
                    }
                } else {
                    console.log("Waiting for face...");
                }
                
                // 使用 requestAnimationFrame 比 setInterval 更平滑且省资源
                requestAnimationFrame(runDetection);
            };

            runDetection();
        } catch (err) {
            updateStatus("Guest", "Camera Denied", "error");
        }
    }

    function stopCamera() {
        scanActive = false;
        const video = document.getElementById('video');
        if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
    }

    function updateStatus(op, stat, cls) {
        document.getElementById('top-op').innerText = "Operator: " + op;
        document.getElementById('top-status').innerText = "Status: " + stat;
        const msg = document.getElementById('status-msg');
        msg.innerText = stat;
        msg.className = cls;
    }
</script>
</body>
</html>
