<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMKSS Security Dashboard</title>
    <link rel="icon" type="image/png" href="semsira.png">
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary: #e67e22; --bg: #0a0a0a; --card: #181818; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .info-header { position: absolute; top: 20px; right: 20px; text-align: right; font-size: 11px; font-family: monospace; z-index: 100; }
        #top-status { color: var(--primary); font-weight: bold; text-transform: uppercase; }
        .login-card { background: var(--card); padding: 40px; border-radius: 24px; width: 360px; text-align: center; border: 1px solid #222; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .logo { width: 80px; margin-bottom: 10px; filter: drop-shadow(0 0 10px rgba(230, 126, 34, 0.4)); }
        #face-area { display: none; width: 100%; height: 240px; background: #000; border-radius: 12px; margin-bottom: 20px; border: 2px solid var(--primary); overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .btn-face { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid var(--primary); background: transparent; color: var(--primary); font-weight: bold; cursor: pointer; transition: 0.3s; text-transform: uppercase; }
        .btn-face:disabled { border-color: #333; color: #444; cursor: not-allowed; }
        .btn-face:hover:not(:disabled) { background: var(--primary); color: white; }
        #status-msg { margin-top: 15px; font-size: 12px; font-weight: bold; letter-spacing: 1px; }
        .loading { color: var(--primary); } .success { color: #2ecc71; } .error { color: #e74c3c; }
    </style>
</head>
<body>

<div class="info-header">
    <div>SYSTEM_OP: <span id="top-op">GUEST</span></div>
    <div>ENCRYPTION: <span id="top-status">OFFLINE</span></div>
</div>

<div class="login-card">
    <img src="semsira.png" alt="Logo" class="logo">
    <h2 style="color:var(--primary); margin:0; letter-spacing: 2px;">DASHBOARD</h2>
    <p style="font-size: 10px; color:#555; margin-bottom:20px;">BIOMETRIC BRIDGE v5.6</p>

    <div id="face-area"><video id="video" autoplay muted playsinline></video></div>
    
    <button type="button" id="scanBtn" class="btn-face" onclick="startSecureScan()" disabled>SYNCHRONIZING...</button>
    <div id="status-msg">INITIALIZING MODELS...</div>
</div>

<script>
    // 配置参数
    const CONFIG = {
        OWNER: "bdpsemsira",
        REPO: "bdpsemsira.github.io",
        PATH: "keys.txt",
        TARGET: "sks_panel_982x.html",
        DIST_THRESHOLD: 0.48 // 识别精度，越小越严
    };

    let faceMatcher = null;
    let isScanning = false;

    window.onload = async () => {
        try {
            updateUI("SYSTEM", "LOADING AI", "loading");
            // 并行加载模型
            await Promise.all([
                faceapi.nets.ssdMobilenetv1.loadFromUri('./model'),
                faceapi.nets.faceLandmark68Net.loadFromUri('./model'),
                faceapi.nets.faceRecognitionNet.loadFromUri('./model')
            ]);
            
            updateUI("SYSTEM", "FETCHING DB", "loading");
            const dbLoaded = await syncDatabase();
            
            if (dbLoaded) {
                updateUI("GUEST", "SYSTEM READY", "success");
                const btn = document.getElementById('scanBtn');
                btn.disabled = false;
                btn.innerText = "START BIOMETRIC SCAN";
                document.getElementById('top-status').innerText = "ENCRYPTED";
            } else {
                updateUI("SYSTEM", "DATABASE EMPTY", "error");
                document.getElementById('scanBtn').innerText = "DB ERROR";
            }
        } catch (e) {
            updateUI("SYSTEM", "INIT FAILED", "error");
            console.error("Critical Init Error:", e);
        }
    };

    // 强力解析函数
    async function syncDatabase() {
        try {
            const url = `https://raw.githubusercontent.com/${CONFIG.OWNER}/${CONFIG.REPO}/main/${CONFIG.PATH}?t=${Date.now()}`;
            const res = await fetch(url);
            if (!res.ok) return false;
            
            const rawContent = await res.text();
            // 过滤 GitHub 可能返回的 HTML 报错页面
            if (rawContent.includes("<!DOCTYPE html>")) return false;

            const lines = rawContent.split(/\r?\n/).filter(l => l.includes('['));
            const labeledDescriptors = [];

            for (let line of lines) {
                try {
                    // 1. 提取名字（第一个冒号前）
                    const name = line.split(':')[0].trim();
                    // 2. 正则提取 [ ... ] 之间的内容
                    const arrayMatch = line.match(/\[(.*?)\]/);
                    if (!arrayMatch) continue;

                    // 3. 将抠出来的字符串转为 Float32Array
                    const vectorData = JSON.parse(`[${arrayMatch[1]}]`);
                    const descriptor = new Float32Array(vectorData);
                    
                    labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [descriptor]));
                    console.log(`Successfully synced user: ${name}`);
                } catch (err) {
                    console.warn("Skipping line due to parse error");
                }
            }

            if (labeledDescriptors.length > 0) {
                faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
                return true;
            }
        } catch (e) { console.error("Sync Error:", e); }
        return false;
    }

    async function startSecureScan() {
        if (isScanning || !faceMatcher) return;
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            const video = document.getElementById('video');
            video.srcObject = stream;
            document.getElementById('face-area').style.display = 'block';
            isScanning = true;
            updateUI("SCANNER", "SCANNING...", "loading");

            const detect = async () => {
                if (!isScanning) return;

                const detection = await faceapi.detectSingleFace(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.4 }))
                                             .withFaceLandmarks()
                                             .withFaceDescriptor();
                
                if (detection) {
                    const match = faceMatcher.findBestMatch(detection.descriptor);
                    console.log(`Identify: ${match.label} (${match.distance.toFixed(3)})`);

                    if (match.label !== 'unknown' && match.distance < CONFIG.DIST_THRESHOLD) {
                        isScanning = false;
                        updateUI(match.label, "ACCESS GRANTED", "success");
                        stopCamera();
                        sessionStorage.setItem('access_granted', 'true');
                        sessionStorage.setItem('admin_name', match.label);
                        setTimeout(() => window.location.replace(CONFIG.TARGET), 800);
                        return;
                    } else {
                        updateUI("GUEST", `IDENTIFYING: ${match.label}`, "loading");
                    }
                }
                requestAnimationFrame(detect);
            };
            detect();
        } catch (err) {
            updateUI("SYSTEM", "CAMERA ERROR", "error");
        }
    }

    function stopCamera() {
        const video = document.getElementById('video');
        if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
        document.getElementById('face-area').style.display = 'none';
    }

    function updateUI(op, stat, cls) {
        document.getElementById('top-op').innerText = op;
        const msg = document.getElementById('status-msg');
        msg.innerText = stat;
        msg.className = cls;
    }
</script>
</body>
</html>
