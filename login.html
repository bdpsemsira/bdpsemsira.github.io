<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMKSS Dashboard | Secure Access</title>
    <link rel="icon" type="image/png" href="semsira.png">
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary: #e67e22; --bg: #0a0a0a; --card: #181818; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .info-header { position: absolute; top: 20px; right: 20px; text-align: right; font-size: 11px; font-family: monospace; z-index: 100; }
        #top-status { color: var(--primary); font-weight: bold; }
        .login-card { background: var(--card); padding: 40px; border-radius: 24px; width: 360px; text-align: center; border: 1px solid #222; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .logo { width: 80px; margin-bottom: 10px; filter: drop-shadow(0 0 10px rgba(230, 126, 34, 0.4)); }
        #face-area { display: none; width: 100%; height: 240px; background: #000; border-radius: 12px; margin-bottom: 20px; border: 2px solid var(--primary); overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .btn-face { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid var(--primary); background: transparent; color: var(--primary); font-weight: bold; cursor: pointer; transition: 0.3s; text-transform: uppercase; }
        .btn-face:disabled { border-color: #333; color: #555; cursor: not-allowed; }
        .btn-face:hover:not(:disabled) { background: var(--primary); color: white; }
        #status-msg { margin-top: 15px; font-size: 12px; font-weight: bold; }
        .loading { color: var(--primary); } .success { color: #2ecc71; } .error { color: #e74c3c; }
    </style>
</head>
<body>

<div class="info-header">
    <div>OPERATOR: <span id="top-op">GUEST</span></div>
    <div>SYSTEM: <span id="top-status">BOOTING</span></div>
</div>

<div class="login-card">
    <img src="semsira.png" alt="Logo" class="logo">
    <h2 style="color:var(--primary); margin:0; letter-spacing: 2px;">DASHBOARD</h2>
    <p style="font-size: 10px; color:#555; margin-bottom:20px;">V6.1 BIOMETRIC STACK</p>

    <div id="face-area"><video id="video" autoplay muted playsinline></video></div>
    
    <button type="button" id="scanBtn" class="btn-face" onclick="startSecureScan()" disabled>SYNCING DATABASE...</button>
    <div id="status-msg">SYSTEM INITIALIZING...</div>
</div>

<script>
    const CONFIG = {
        OWNER: "bdpsemsira",
        REPO: "bdpsemsira.github.io",
        FILE: "keys.txt",
        TARGET: "sks_panel_982x.html",
        THRESHOLD: 0.52 // 识别灵敏度
    };

    let faceMatcher = null;
    let isScanning = false;

    // 1. 启动初始化
    window.onload = async () => {
        try {
            updateUI("SYSTEM", "LOADING MODELS", "loading");
            await Promise.all([
                faceapi.nets.ssdMobilenetv1.loadFromUri('./model'),
                faceapi.nets.faceLandmark68Net.loadFromUri('./model'),
                faceapi.nets.faceRecognitionNet.loadFromUri('./model')
            ]);
            
            updateUI("SYSTEM", "SYNCING USERS", "loading");
            const dbStatus = await syncDatabase();
            
            if (dbStatus) {
                updateUI("GUEST", "READY", "success");
                document.getElementById('top-status').innerText = "ONLINE";
                document.getElementById('scanBtn').disabled = false;
                document.getElementById('scanBtn').innerText = "START BIO-SCAN";
            } else {
                updateUI("SYSTEM", "DB EMPTY", "error");
            }
        } catch (e) {
            updateUI("SYSTEM", "INIT ERROR", "error");
            console.error(e);
        }
    };

    // 2. 核心：全量同步数据库
    async function syncDatabase() {
        try {
            const url = `https://raw.githubusercontent.com/${CONFIG.OWNER}/${CONFIG.REPO}/main/${CONFIG.FILE}?t=${Date.now()}`;
            const res = await fetch(url);
            const text = await res.text();
            
            // 兼容各种换行符，并过滤空行
            const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 20);
            const labeledDescriptors = [];

            console.log(`[Database] Found ${lines.length} lines.`);

            for (let line of lines) {
                try {
                    // 提取名字：取第一个冒号前的内容
                    const name = line.split(':')[0].trim();
                    // 提取数组：抠出 [ ... ] 内部的东西
                    const arrayMatch = line.match(/\[(.*?)\]/);
                    
                    if (name && arrayMatch) {
                        const vector = new Float32Array(JSON.parse(`[${arrayMatch[1]}]`));
                        labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [vector]));
                        // 每一个成功的都会显示，如果这里没出 ZAKWAN，说明那一行的格式有问题
                        console.log(`%c[OK] Synced: ${name}`, "color: #2ecc71; font-weight: bold;");
                    }
                } catch (err) {
                    console.warn("Failed to parse line, moving to next...");
                }
            }

            if (labeledDescriptors.length > 0) {
                faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, CONFIG.THRESHOLD);
                return true;
            }
        } catch (e) { console.error("Sync Error:", e); }
        return false;
    }

    // 3. 扫描逻辑
    async function startSecureScan() {
        if (isScanning || !faceMatcher) return;
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            const video = document.getElementById('video');
            video.srcObject = stream;
            document.getElementById('face-area').style.display = 'block';
            isScanning = true;
            updateUI("SCANNER", "SCANNING...", "loading");

            const detect = async () => {
                if (!isScanning) return;

                const result = await faceapi.detectSingleFace(video)
                                          .withFaceLandmarks()
                                          .withFaceDescriptor();
                
                if (result) {
                    const match = faceMatcher.findBestMatch(result.descriptor);
                    // 调试输出：看看 AI 认为你是谁
                    console.log(`Match: ${match.label} (${match.distance.toFixed(3)})`);

                    if (match.label !== 'unknown' && match.distance < CONFIG.THRESHOLD) {
                        isScanning = false;
                        updateUI(match.label, "ACCESS GRANTED", "success");
                        
                        // 停止摄像头
                        video.srcObject.getTracks().forEach(t => t.stop());
                        
                        sessionStorage.setItem('access_granted', 'true');
                        sessionStorage.setItem('admin_name', match.label);
                        setTimeout(() => window.location.replace(CONFIG.TARGET), 1000);
                        return;
                    } else {
                        updateUI("GUEST", `IDENTIFYING: ${match.label}`, "loading");
                    }
                }
                requestAnimationFrame(detect);
            };
            detect();
        } catch (err) {
            updateUI("SYSTEM", "CAMERA ERROR", "error");
        }
    }

    function updateUI(op, stat, cls) {
        document.getElementById('top-op').innerText = op;
        const msg = document.getElementById('status-msg');
        msg.innerText = stat;
        msg.className = cls;
    }
</script>
</body>
</html>
