<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management Panel | SEMSIRA BDP</title>
    <link rel="icon" type="image/png" href="semsira.png">
    <style>
        :root {
            --accent: #f1c40f; 
            --accent-hover: #f39c12;
            --bg: #0a0a0a;
            --card: #181818;
            --input-bg: #0f0f0f;
            --text: #ffffff;
            --text-dim: #666;
            --color-late: #ffeb3b;
            --color-skipping: #ff9800;
            --color-bullying: #f44336;
            --color-discrimination: #ff5252;
            --color-contraband: #e91e63;
            --color-drugs: #9c27b0;
            --color-others: #00d2ff;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            margin: 0; background-color: var(--bg); color: var(--text);
            display: flex; flex-direction: column; min-height: 100vh;
        }

        .navbar {
            background-color: #000; padding: 15px 40px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 2px solid #222;
        }
        .nav-brand { display: flex; align-items: center; }
        .nav-brand img { height: 45px; margin-right: 15px; filter: drop-shadow(0 0 10px rgba(241, 196, 15, 0.3)); }
        .nav-brand h1 { font-size: 20px; color: var(--accent); margin: 0; letter-spacing: 1px; font-weight: 800; text-transform: uppercase; }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; flex: 1; }

        .card {
            background: var(--card); padding: 25px; border-radius: 16px;
            margin-bottom: 25px; border: 1px solid #222;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        h3 { color: var(--accent); margin-top: 0; font-size: 13px; text-transform: uppercase; letter-spacing: 2px; border-left: 3px solid var(--accent); padding-left: 10px; margin-bottom: 20px;}

        .input-group { display: flex; gap: 12px; flex-wrap: wrap; }
        input, select { 
            background: var(--input-bg); border: 1px solid #333; color: white; 
            padding: 14px; border-radius: 8px; flex: 1; min-width: 150px; transition: 0.3s;
        }
        input:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 10px rgba(241, 196, 15, 0.1); }
        
        button { 
            background: var(--accent); color: black; padding: 12px 24px; border: none; 
            border-radius: 8px; cursor: pointer; font-weight: bold; text-transform: uppercase; transition: 0.3s;
        }
        button:hover { background: var(--accent-hover); transform: translateY(-2px); }

        #searchBox { 
            width: 100%; margin-bottom: 25px; font-size: 16px; border: 1px solid #333;
            background: #000; padding: 15px 20px; border-radius: 12px; color: white;
        }

        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { color: var(--text-dim); padding: 15px; text-align: left; font-size: 11px; text-transform: uppercase; }
        td { background: #1a1a1a; padding: 18px; border-top: 1px solid #282828; border-bottom: 1px solid #282828; }
        td:first-child { border-left: 1px solid #282828; border-radius: 12px 0 0 12px; }
        td:last-child { border-right: 1px solid #282828; border-radius: 0 12px 12px 0; }
        
        .offence-tag {
            display: inline-flex; align-items: center; 
            background: #252525; padding: 6px 12px; margin: 4px; border-radius: 6px; 
            font-size: 12px; font-weight: 600; cursor: pointer; transition: 0.2s;
            border-left: 4px solid #555;
        }
        .offence-tag:hover { background: #333; transform: scale(1.02); }

        /* Color Groups */
        .tag-late { border-left-color: var(--color-late) !important; color: var(--color-late); }
        .tag-skipping { border-left-color: var(--color-skipping) !important; color: var(--color-skipping); }
        .tag-bullying { border-left-color: var(--color-bullying) !important; color: var(--color-bullying); }
        .tag-discrimination { border-left-color: var(--color-discrimination) !important; color: var(--color-discrimination); }
        .tag-contraband { border-left-color: var(--color-contraband) !important; color: var(--color-contraband); }
        .tag-drugs { border-left-color: var(--color-drugs) !important; color: var(--color-drugs); }
        .tag-others { border-left-color: var(--color-others) !important; color: var(--color-others); }

        .time-hint { display: block; font-size: 9px; color: #888; margin-top: 2px; font-weight: normal; }

        .remove-single { 
            margin-left: 10px; padding: 2px 5px; border-radius: 4px;
            cursor: pointer; color: #666; font-size: 16px; 
        }
        .remove-single:hover { color: #ff4d4d; background: rgba(255, 77, 77, 0.1); }

        .count-badge {
            background: rgba(241, 196, 15, 0.1); color: var(--accent);
            padding: 6px 14px; border-radius: 8px; border: 1px solid var(--accent); font-weight: 800;
        }

        .warning-row td { background: #2d1616 !important; border-color: #4d2626 !important; }
        .delete-btn { background: #331111; color: #ff4d4d; border: 1px solid #442222; padding: 8px 16px; font-size: 11px; border-radius: 6px; }
        .delete-btn:hover { background: #ff4d4d; color: white; }

        /* Master Reset Button Styling */
        .master-reset-container { text-align: right; padding-top: 50px; opacity: 0.3; transition: 0.3s; }
        .master-reset-container:hover { opacity: 1; }
        .master-btn { background: #1a0000; color: #ff0000; border: 1px solid #440000; font-size: 10px; padding: 10px 20px; letter-spacing: 1px; }
        .master-btn:hover { background: #ff0000; color: white; box-shadow: 0 0 20px rgba(255,0,0,0.3); }

        .footer { text-align: center; padding: 30px; color: var(--text-dim); font-size: 11px; letter-spacing: 1px; }
    </style>
</head>
<body oncontextmenu="return false">

<script>
    if (sessionStorage.getItem('access_granted') !== 'true') {
        window.location.replace('index.html'); 
    }
</script>

<div class="navbar">
    <div class="nav-brand">
        <img src="semsira.png" alt="SEMSIRA">
        <h1>SEMSIRA BADAN DISIPLIN PELAJAR</h1>
    </div>
    <div style="font-size: 10px; color: #444;">SECURITY: <span style="color: var(--accent);">FULL SYSTEM v3.6</span></div>
</div>

<div class="container">
    <div class="card">
        <h3>1. DATA ENTRY</h3>
        <div class="input-group">
            <input type="text" id="stuName" placeholder="STUDENT FULL NAME">
            <input type="text" id="stuClass" placeholder="CLASS (E.G. 5T1)">
            <select id="violation">
                <option value="" disabled selected>SELECT OFFENCE TYPE</option>
                <option value="Late">LATE</option>
                <option value="Skipping Class">SKIPPING CLASS</option>
                <option value="Bullying">BULLYING</option>
                <option value="Discrimination">DISCRIMINATION</option>
                <option value="Contraband">CONTRABAND</option>
                <option value="Severe Misconduct/Drugs">SEVERE MISCONDUCT / DRUGS</option>
                <option value="Others">OTHERS</option>
            </select>
            <button onclick="submitRecord()">Commit Entry</button>
        </div>
    </div>

    <div class="card" style="background: transparent; border: none; box-shadow: none; padding: 0;">
        <h3>2. RECORD LOG (CLICK TAG TO VIEW ALL TIMES)</h3>
        <input type="text" id="searchBox" onkeyup="filterRecords()" placeholder="SEARCH BY NAME OR CLASS IDENTITY...">

        <table>
            <thead>
                <tr>
                    <th width="22%">Student Identity</th>
                    <th width="48%">History of Offences</th>
                    <th width="15%" style="text-align:center">Counter</th>
                    <th width="15%">Action</th>
                </tr>
            </thead>
            <tbody id="recordBody">
            </tbody>
        </table>
    </div>

    <div class="master-reset-container">
        <button class="master-btn" onclick="masterSystemReset()">ANNUAL SYSTEM RESET</button>
        <p style="font-size: 9px; color: #444; margin-top: 5px;">*Danger Zone: Clears entire database for new academic year.</p>
    </div>
</div>

<div class="footer">CLOUD SYNTHESIS ENGINE v3.6 | PRECISION DATA MANAGEMENT<br>&copy; 2026 SEMSIRA | ZIJUN</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, where, getDocs, getDoc, increment, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqY9ADs8oy1Uvh3-7eVCQLYfyTijm8lo4",
        authDomain: "bdpsemsira-5c274.firebaseapp.com",
        projectId: "bdpsemsira-5c274",
        storageBucket: "bdpsemsira-5c274.firebasestorage.app",
        messagingSenderId: "176946808975",
        appId: "1:176946808975:web:ef7447a11bb57fe71b88fa"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "students");

    function getTagClass(offence) {
        if (offence.includes("Late")) return "tag-late";
        if (offence.includes("Skipping")) return "tag-skipping";
        if (offence.includes("Bullying")) return "tag-bullying";
        if (offence.includes("Discrimination")) return "tag-discrimination";
        if (offence.includes("Contraband")) return "tag-contraband";
        if (offence.includes("Severe") || offence.includes("Drugs")) return "tag-drugs";
        return "tag-others";
    }

    function getCurrentTime() {
        const now = new Date();
        return now.toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    window.viewHistory = (name, type, timesStr) => {
        const times = timesStr.split('|');
        let list = times.map((t, i) => `${i+1}. ${t}`).join('\n');
        alert(`Student: ${name}\nOffence: ${type}\n\nFull Record History:\n${list}`);
    }

    window.submitRecord = async () => {
        const name = document.getElementById('stuName').value.trim().toUpperCase();
        const className = document.getElementById('stuClass').value.trim().toUpperCase();
        const offenceType = document.getElementById('violation').value;

        if (!name || !className || !offenceType) {
            alert("All fields are mandatory.");
            return;
        }

        const offenceObject = { type: offenceType, time: getCurrentTime() };

        try {
            const q = query(colRef, where("name", "==", name), where("class", "==", className));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const studentDoc = querySnapshot.docs[0];
                const newOffences = [...studentDoc.data().offences, offenceObject];
                await updateDoc(doc(db, "students", studentDoc.id), {
                    offences: newOffences,
                    counts: increment(1)
                });
            } else {
                await addDoc(colRef, { name, class: className, offences: [offenceObject], counts: 1 });
            }
            document.getElementById('stuName').value = "";
            document.getElementById('violation').selectedIndex = 0;
        } catch (e) { alert("Error: " + e.message); }
    };

    onSnapshot(colRef, (snapshot) => {
        let html = "";
        snapshot.docs.forEach(docData => {
            const data = docData.data();
            const id = docData.id;
            const groups = {};
            
            data.offences.forEach(obj => {
                const type = typeof obj === 'string' ? obj : obj.type;
                const time = typeof obj === 'string' ? "N/A" : obj.time;
                if (!groups[type]) groups[type] = [];
                groups[type].push(time);
            });

            let offencesHtml = Object.keys(groups).map(type => {
                const times = groups[type];
                const count = times.length;
                const latestTime = times[times.length - 1];
                const allTimesStr = times.join('|'); 
                
                const displayLabel = count > 1 ? `${type} <b style="color:white; margin-left:4px;">x${count}</b>` : type;
                
                return `
                    <span class="offence-tag ${getTagClass(type)}" 
                          onclick="viewHistory('${data.name}', '${type}', '${allTimesStr}')">
                        <div style="display:flex; flex-direction:column">
                            <span>${displayLabel}</span>
                            <span class="time-hint">Last: ${latestTime}</span>
                        </div>
                        <span class="remove-single" onclick="event.stopPropagation(); deleteSingle('${id}', '${type}')">Ã—</span>
                    </span>
                `;
            }).join("");

            const warningRow = data.counts >= 3 ? "warning-row" : "";

            html += `
                <tr class="${warningRow}">
                    <td>
                        <div style="font-weight:800; color:white; font-size:16px;">${data.name}</div>
                        <div style="color:var(--accent); font-size:11px; margin-top:4px;">CLASS: ${data.class}</div>
                    </td>
                    <td>${offencesHtml}</td>
                    <td style="text-align:center"><span class="count-badge">${data.counts}</span></td>
                    <td><button class="delete-btn" onclick="purgeStudent('${id}')">Purge All</button></td>
                </tr>
            `;
        });
        document.getElementById('recordBody').innerHTML = html;
    });

    window.deleteSingle = async (id, typeName) => {
        if(confirm(`Remove one instance of: ${typeName}?`)) {
            try {
                const dRef = doc(db, "students", id);
                const docSnap = await getDoc(dRef);
                if (docSnap.exists()) {
                    let list = docSnap.data().offences;
                    let index = -1;
                    for (let i = list.length - 1; i >= 0; i--) {
                        if ((typeof list[i] === 'string' ? list[i] : list[i].type) === typeName) {
                            index = i; break;
                        }
                    }
                    if (index > -1) {
                        list.splice(index, 1);
                        await updateDoc(dRef, { offences: list, counts: increment(-1) });
                    }
                }
            } catch (e) { alert("Error: " + e.message); }
        }
    };

    window.purgeStudent = async (id) => {
        if(confirm("PERMANENTLY PURGE ENTIRE IDENTITY?")) await deleteDoc(doc(db, "students", id));
    };

    // MASTER RESET FUNCTION
    window.masterSystemReset = async () => {
        const step1 = confirm("WARNING: This will delete ALL student records in the database. Are you absolutely sure?");
        if (!step1) return;

        const step2 = confirm("FINAL WARNING: This action cannot be undone. All disciplinary history will be lost. Proceed?");
        if (!step2) return;

        const verify = prompt("To confirm, please type 'RESET2026' below:");
        if (verify === "RESET2026") {
            try {
                const querySnapshot = await getDocs(colRef);
                // Use a batch to delete everything efficiently
                import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js").then(async (fs) => {
                    const batch = fs.writeBatch(db);
                    querySnapshot.forEach((d) => {
                        batch.delete(d.ref);
                    });
                    await batch.commit();
                    alert("System Reset Successful. Database is now empty.");
                });
            } catch (e) { alert("Reset Error: " + e.message); }
        } else {
            alert("Verification failed. Reset aborted.");
        }
    };

    window.filterRecords = () => {
        const term = document.getElementById('searchBox').value.toLowerCase();
        document.querySelectorAll('#recordBody tr').forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(term) ? "" : "none";
        });
    };
</script>
</body>
</html>
