<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management Panel | SEMSIRA BDP</title>
    <link rel="icon" type="image/png" href="semsira.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --accent: #f1c40f; 
            --accent-hover: #f39c12;
            --bg: #0a0a0a;
            --card: #181818;
            --input-bg: #0f0f0f;
            --text: #ffffff;
            --text-dim: #666;
            --color-late: #ffeb3b;
            --color-skipping: #ff9800;
            --color-bullying: #f44336;
            --color-discrimination: #ff5252;
            --color-contraband: #e91e63;
            --color-drugs: #9c27b0;
            --color-others: #00d2ff;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            margin: 0; background-color: var(--bg); color: var(--text);
            display: flex; flex-direction: column; min-height: 100vh;
        }

        /* 主界面样式 */
        .navbar { background-color: #000; padding: 15px 40px; display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #222; }
        .nav-brand { display: flex; align-items: center; }
        .nav-brand img { height: 45px; margin-right: 15px; }
        .nav-brand h1 { font-size: 20px; color: var(--accent); margin: 0; letter-spacing: 1px; font-weight: 800; text-transform: uppercase; }
        .admin-tag { font-size: 10px; color: #444; }
        .admin-name { color: var(--accent); font-weight: bold; border: 1px solid #333; padding: 2px 8px; border-radius: 4px; margin-left: 5px; }
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; flex: 1; }
        .card { background: var(--card); padding: 25px; border-radius: 16px; margin-bottom: 25px; border: 1px solid #222; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h3 { color: var(--accent); font-size: 13px; text-transform: uppercase; letter-spacing: 2px; border-left: 3px solid var(--accent); padding-left: 10px; margin-bottom: 20px;}
        .input-group { display: flex; gap: 12px; flex-wrap: wrap; }
        input, select { background: var(--input-bg); border: 1px solid #333; color: white; padding: 14px; border-radius: 8px; flex: 1; min-width: 150px; }
        button { background: var(--accent); color: black; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; text-transform: uppercase; transition: 0.3s; }
        button:hover:not(:disabled) { background: var(--accent-hover); transform: translateY(-2px); }
        #searchBox { width: 100%; margin-bottom: 25px; font-size: 16px; border: 1px solid #333; background: #000; padding: 15px 20px; border-radius: 12px; color: white; }

        /* 主表格 */
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { color: var(--text-dim); padding: 15px; text-align: left; font-size: 11px; }
        td { background: #1a1a1a; padding: 18px; border-top: 1px solid #282828; border-bottom: 1px solid #282828; }
        .offence-tag { display: inline-flex; align-items: center; background: #252525; padding: 6px 12px; margin: 4px; border-radius: 6px; font-size: 12px; font-weight: 600; border-left: 4px solid #555; cursor: pointer; }
        .count-badge { background: rgba(241, 196, 15, 0.1); color: var(--accent); padding: 6px 14px; border-radius: 8px; border: 1px solid var(--accent); font-weight: 800; }
        .delete-btn { background: #331111; color: #ff4d4d; border: 1px solid #442222; padding: 8px 16px; font-size: 11px; border-radius: 6px; }

        .pagination-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding: 15px; background: #111; border-radius: 12px; }
        .action-bar { display: flex; justify-content: flex-end; align-items: center; gap: 15px; margin-top: 50px; padding: 20px; border-top: 1px solid #222; }
        .report-btn { background: #27ae60; color: white; }
        .date-picker { padding: 10px; background: #111; border: 1px solid #444; color: white; border-radius: 6px; }
        .master-btn { background: #1a0000; color: #ff0000; border: 1px solid #440000; font-size: 10px; padding: 10px 20px; }

        /* ==========================================================
           【导出模板美化修复 - 强制白底黑字】
           ========================================================== */
        #reportExportTemplate {
            position: absolute; left: -9999px; top: 0;
            width: 1000px; 
            background-color: #ffffff !important; 
            color: #000000 !important; 
            padding: 60px;
            box-sizing: border-box;
        }
        .rpt-header { text-align: center; margin-bottom: 30px; border-bottom: 4px double #000; padding-bottom: 20px; }
        .rpt-header h1 { margin: 0; font-size: 32px; color: #000 !important; font-weight: bold; }
        .rpt-info { display: flex; justify-content: space-between; margin-top: 20px; font-weight: bold; font-size: 16px; color: #000 !important; }

        .rpt-table { 
            width: 100%; 
            border-collapse: collapse !important; 
            margin-top: 20px;
            background-color: #ffffff !important;
        }
        .rpt-table th { 
            background-color: #f2f2f2 !important; 
            color: #000 !important;
            border: 2px solid #000 !important; 
            padding: 15px;
            text-align: center;
            font-size: 14px;
            text-transform: uppercase;
        }
        .rpt-table td { 
            background-color: #ffffff !important; /* 强制名字框为白色 */
            border: 1px solid #000 !important; 
            padding: 15px;
            color: #000 !important;
            font-size: 15px;
            text-align: center;
        }
        /* 第一列学生名字样式 */
        .rpt-table td:first-child { 
            text-align: left; 
            font-weight: bold; 
            padding-left: 20px; 
        }

        .rpt-footer { margin-top: 40px; display: flex; justify-content: space-between; font-size: 14px; font-weight: bold; color: #000 !important; }
        .rpt-sign { border-top: 2px solid #000; width: 220px; text-align: center; margin-top: 60px; padding-top: 5px; color: #000 !important; }

        .footer { text-align: center; padding: 30px; color: var(--text-dim); font-size: 11px; }
    </style>
</head>
<body oncontextmenu="return false">

<script>
    const currentAdmin = sessionStorage.getItem('admin_name');
    if (sessionStorage.getItem('access_granted') !== 'true' || !currentAdmin) { 
        window.location.replace('index.html'); 
    }
</script>

<div class="navbar">
    <div class="nav-brand">
        <img src="semsira.png" alt="SEMSIRA">
        <h1>SEMSIRA BDP MANAGEMENT</h1>
    </div>
    <div class="admin-tag">OPERATOR <span class="admin-name" id="displayAdmin">OFFLINE</span></div>
</div>

<div class="container">
    <div class="card">
        <h3>1. LOG ENTRY</h3>
        <div class="input-group">
            <input type="text" id="stuName" placeholder="STUDENT FULL NAME">
            <input type="text" id="stuClass" placeholder="CLASS (E.G. 6A)">
            <select id="violation">
                <option value="" disabled selected>SELECT OFFENCE TYPE</option>
                <option value="Late">LATE</option>
                <option value="Skipping Class">SKIPPING CLASS</option>
                <option value="Bullying">BULLYING</option>
                <option value="Discrimination">DISCRIMINATION</option>
                <option value="Contraband">CONTRABAND</option>
                <option value="Severe Misconduct/Drugs">SEVERE MISCONDUCT / DRUGS</option>
                <option value="Others">OTHERS</option>
            </select>
            <button onclick="submitRecord()">Commit Entry</button>
        </div>
    </div>

    <div class="card" style="background: transparent; border: none; padding: 0;">
        <h3>2. DISCIPLINARY RECORDS</h3>
        <input type="text" id="searchBox" onkeyup="handleSearch()" placeholder="SEARCH BY NAME OR CLASS...">
        <table>
            <thead>
                <tr>
                    <th width="25%">Identity</th>
                    <th width="45%">Offence History</th>
                    <th width="15%" style="text-align:center">Total</th>
                    <th width="15%">Action</th>
                </tr>
            </thead>
            <tbody id="recordBody"></tbody>
        </table>
        <div class="pagination-bar">
            <button id="prevBtn" onclick="changePage(-1)">PREVIOUS</button>
            <div class="page-info" id="pageDisplay">Page 1 of 1</div>
            <button id="nextBtn" onclick="changePage(1)">NEXT PAGE</button>
        </div>
    </div>

    <div class="action-bar">
        <span style="font-size: 12px; color: #666;">REPORT DATE:</span>
        <input type="date" id="reportDate" class="date-picker">
        <button class="report-btn" onclick="downloadReport()">Download PNG Report</button>
        <div style="width: 40px;"></div>
        <button class="master-btn" onclick="masterSystemReset()">ANNUAL RESET</button>
    </div>
</div>

<div id="reportExportTemplate">
    <div class="rpt-header">
        <h1>SEMSIRA BDP DISCIPLINE REPORT</h1>
        <div class="rpt-info">
            <span id="rptDateSpan">DATE: --/--/----</span>
            <span id="rptAdminSpan">OPERATOR: ----</span>
        </div>
    </div>
    <table class="rpt-table">
        <thead>
            <tr>
                <th width="30%">Student Name</th>
                <th width="15%">Class</th>
                <th width="20%">Offence</th>
                <th width="15%">Time</th>
                <th width="20%">Recorder</th>
            </tr>
        </thead>
        <tbody id="reportTbody"></tbody>
    </table>
    <div class="rpt-footer">
        <div>Total cases on this date: <span id="rptTotalCase">0</span></div>
        <div style="text-align: right;">
            <p>Official SEMSIRA BDP Document</p>
            <div class="rpt-sign">Authorized Signature</div>
        </div>
    </div>
</div>

<div class="footer">CLOUD SYNTHESIS ENGINE v4.3 | &copy; 2026 SEMSIRA</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, where, getDocs, getDoc, increment, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqY9ADs8oy1Uvh3-7eVCQLYfyTijm8lo4",
        authDomain: "bdpsemsira-5c274.firebaseapp.com",
        projectId: "bdpsemsira-5c274",
        storageBucket: "bdpsemsira-5c274.firebasestorage.app",
        messagingSenderId: "176946808975",
        appId: "1:176946808975:web:ef7447a11bb57fe71b88fa"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "students");

    document.getElementById('displayAdmin').innerText = currentAdmin;
    document.getElementById('reportDate').valueAsDate = new Date();

    let allStudents = [];
    let filteredStudents = [];
    let currentPage = 1;
    const pageSize = 20;

    function getTagClass(offence) {
        if (offence.includes("Late")) return "tag-late";
        if (offence.includes("Skipping")) return "tag-skipping";
        if (offence.includes("Bullying")) return "tag-bullying";
        if (offence.includes("Discrimination")) return "tag-discrimination";
        if (offence.includes("Contraband")) return "tag-contraband";
        if (offence.includes("Severe")) return "tag-drugs";
        return "tag-others";
    }

    onSnapshot(colRef, (snapshot) => {
        allStudents = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        handleSearch(); 
    });

    window.handleSearch = () => {
        const term = document.getElementById('searchBox').value.toLowerCase();
        filteredStudents = allStudents.filter(s => s.name.toLowerCase().includes(term) || s.class.toLowerCase().includes(term));
        currentPage = 1; renderTable();
    };

    window.changePage = (dir) => { currentPage += dir; renderTable(); };

    function renderTable() {
        const totalPages = Math.ceil(filteredStudents.length / pageSize) || 1;
        const pageData = filteredStudents.slice((currentPage - 1) * pageSize, currentPage * pageSize);
        document.getElementById('prevBtn').disabled = (currentPage === 1);
        document.getElementById('nextBtn').disabled = (currentPage === totalPages);
        document.getElementById('pageDisplay').innerText = `PAGE ${currentPage} OF ${totalPages}`;

        let html = "";
        pageData.forEach(data => {
            const groups = {};
            data.offences.forEach(obj => {
                if (!groups[obj.type]) groups[obj.type] = [];
                groups[obj.type].push(obj);
            });

            let offencesHtml = Object.keys(groups).map(type => {
                const items = groups[type];
                const info = items.map((it, i) => `${i+1}. ${it.time} (By: ${it.by || 'N/A'})`).join('|'); 
                return `<span class="offence-tag ${getTagClass(type)}" onclick="viewHistory('${data.name}', '${type}', '${info}')">
                    <div style="display:flex; flex-direction:column">
                        <span>${type} ${items.length > 1 ? `<b>x${items.length}</b>`:''}</span>
                        <span class="time-hint">By: ${items[items.length-1].by || 'N/A'}</span>
                    </div>
                    <span class="remove-single" onclick="event.stopPropagation(); deleteSingle('${data.id}', '${type}')">×</span>
                </span>`;
            }).join("");

            html += `<tr>
                <td><b>${data.name}</b><br><small style="color:var(--accent)">${data.class}</small></td>
                <td>${offencesHtml}</td>
                <td style="text-align:center"><span class="count-badge">${data.counts}</span></td>
                <td><button class="delete-btn" onclick="purgeStudent('${data.id}')">Purge</button></td>
            </tr>`;
        });
        document.getElementById('recordBody').innerHTML = html || '<tr><td colspan="4">No Records Found</td></tr>';
    }

    window.submitRecord = async () => {
        const name = document.getElementById('stuName').value.trim().toUpperCase();
        const cls = document.getElementById('stuClass').value.trim().toUpperCase();
        const type = document.getElementById('violation').value;
        if (!name || !cls || !type) return alert("Fill all fields");
        const q = query(colRef, where("name", "==", name), where("class", "==", cls));
        const qs = await getDocs(q);
        const log = { type, time: new Date().toLocaleString('en-GB'), by: currentAdmin };
        if (!qs.empty) {
            await updateDoc(doc(db, "students", qs.docs[0].id), { offences: [...qs.docs[0].data().offences, log], counts: increment(1) });
        } else {
            await addDoc(colRef, { name, class: cls, offences: [log], counts: 1 });
        }
        document.getElementById('stuName').value = "";
    };

    window.downloadReport = async () => {
        const dateInput = document.getElementById('reportDate').value;
        if (!dateInput) return alert("Select Date");
        const [y, m, d] = dateInput.split('-');
        const targetDate = `${d}/${m}/${y}`;

        const tbody = document.getElementById('reportTbody');
        tbody.innerHTML = "";
        let count = 0;

        allStudents.forEach(stu => {
            stu.offences.forEach(off => {
                if (off.time && off.time.includes(targetDate)) {
                    count++;
                    tbody.innerHTML += `<tr>
                        <td>${stu.name}</td>
                        <td>${stu.class}</td>
                        <td>${off.type}</td>
                        <td>${off.time.split(', ')[1]}</td>
                        <td>${off.by || 'N/A'}</td>
                    </tr>`;
                }
            });
        });

        if (count === 0) return alert("No records for this date.");

        document.getElementById('rptDateSpan').innerText = "DATE: " + targetDate;
        document.getElementById('rptAdminSpan').innerText = "OPERATOR: " + currentAdmin;
        document.getElementById('rptTotalCase').innerText = count;

        const template = document.getElementById('reportExportTemplate');
        // 关键：在导出前确保它被正确渲染
        html2canvas(template, { 
            backgroundColor: "#ffffff", 
            scale: 2,
            useCORS: true
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `BDP_Report_${targetDate.replace(/\//g,'-')}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        });
    };

    window.viewHistory = (n, t, i) => alert(`Student: ${n}\nOffence: ${t}\n\nLog:\n${i.split('|').join('\n')}`);
    window.deleteSingle = async (id, type) => {
        if(!confirm(`Remove one ${type}?`)) return;
        const snap = await getDoc(doc(db, "students", id));
        let list = snap.data().offences;
        for (let i = list.length - 1; i >= 0; i--) { if (list[i].type === type) { list.splice(i, 1); break; } }
        await updateDoc(doc(db, "students", id), { offences: list, counts: increment(-1) });
    };
    window.purgeStudent = async (id) => { if(confirm("Delete student?")) await deleteDoc(doc(db, "students", id)); };
    window.masterSystemReset = async () => {
        if (confirm("RESET?") && prompt("Type 'RESET2026':") === "RESET2026") {
            const qs = await getDocs(colRef);
            const batch = writeBatch(db);
            qs.forEach(d => batch.delete(d.ref));
            await batch.commit();
        }
    };
</script>
</body>
</html>
