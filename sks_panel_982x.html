<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BDP Panel | SEMSIRA</title>
    <link rel="icon" type="image/png" href="semsira.png">
    <style>
        :root {
            /* Futuristic Orange Palette */
            --accent: #ff8000; 
            --accent-glow: rgba(255, 128, 0, 0.4);
            --bg: #050505;
            --card: #0f1014;
            --input-bg: #16181d;
            --text: #ffffff;
            --text-dim: #70757a;
            
            /* Status Colors */
            --color-late: #f7d716;
            --color-skipping: #ff8000;
            --color-bullying: #ff3131;
            --color-contraband: #ff00ff;
            --color-drugs: #bc13fe;
            --color-others: #00d2ff;
        }

        body { 
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; 
            margin: 0; 
            background-color: var(--bg); 
            color: var(--text);
            display: flex; flex-direction: column; min-height: 100vh;
            letter-spacing: -0.01em;
        }

        /* Sci-Fi Navbar */
        .navbar {
            background-color: rgba(0, 0, 0, 0.8);
            padding: 18px 40px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid #222;
            backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 100;
        }
        .nav-brand { display: flex; align-items: center; }
        .nav-brand img { height: 48px; margin-right: 18px; filter: drop-shadow(0 0 8px var(--accent-glow)); }
        .nav-brand h1 { 
            font-size: 18px; color: var(--accent); margin: 0; 
            letter-spacing: 2px; font-weight: 900; text-transform: uppercase;
            text-shadow: 0 0 15px var(--accent-glow);
        }

        .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; flex: 1; }

        /* Tech Cards */
        .card {
            background: var(--card);
            padding: 28px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #222;
            position: relative;
            overflow: hidden;
        }
        .card::before {
            content: ""; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
            background: var(--accent); box-shadow: 0 0 10px var(--accent-glow);
        }
        
        h3 { 
            color: var(--text-dim); margin-top: 0; font-size: 12px; 
            text-transform: uppercase; letter-spacing: 3px; margin-bottom: 25px;
        }

        /* Inputs & Buttons */
        .input-group { display: flex; gap: 15px; flex-wrap: wrap; }
        input, select { 
            background: var(--input-bg); border: 1px solid #2d3039; color: white; 
            padding: 15px; border-radius: 6px; flex: 1; min-width: 180px; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        input:focus, select:focus { 
            outline: none; border-color: var(--accent); 
            background: #1c1f26; box-shadow: 0 0 15px rgba(255, 128, 0, 0.1); 
        }
        
        button { 
            background: var(--accent); color: #000; padding: 15px 30px; border: none; 
            border-radius: 6px; cursor: pointer; font-weight: 800; 
            text-transform: uppercase; transition: all 0.3s;
            box-shadow: 0 0 20px var(--accent-glow);
        }
        button:hover { background: #ff9500; transform: scale(1.02); box-shadow: 0 0 30px var(--accent-glow); }

        #searchBox { 
            width: 100%; margin-bottom: 30px; font-size: 16px; border: 1px solid #222;
            background: #0a0a0a; padding: 18px 25px; border-radius: 8px; color: var(--accent);
            border-left: 4px solid var(--accent);
        }

        /* Modern Table */
        table { width: 100%; border-collapse: collapse; }
        th { color: var(--text-dim); padding: 15px 10px; text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
        td { background: transparent; padding: 20px 10px; border-bottom: 1px solid #1a1a1a; }
        
        tr:hover td { background: rgba(255, 255, 255, 0.02); }

        /* Dynamic Tags with Glow */
        .offence-tag {
            display: inline-flex; align-items: center; 
            background: rgba(255, 255, 255, 0.03); padding: 6px 12px;
            margin: 4px; border-radius: 4px; font-size: 12px; font-weight: 700;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .tag-late { border-color: var(--color-late); color: var(--color-late); box-shadow: inset 0 0 5px rgba(247, 215, 22, 0.1); }
        .tag-skipping { border-color: var(--color-skipping); color: var(--color-skipping); }
        .tag-bullying { border-color: var(--color-bullying); color: var(--color-bullying); }
        .tag-contraband { border-color: var(--color-contraband); color: var(--color-contraband); }
        .tag-drugs { border-color: var(--color-drugs); color: var(--color-drugs); }
        .tag-others { border-color: var(--color-others); color: var(--color-others); }

        .remove-single { margin-left: 10px; cursor: pointer; opacity: 0.5; font-size: 18px; }
        .remove-single:hover { opacity: 1; color: #ff3131; }

        .count-badge {
            display: inline-block; padding: 5px 15px; border-radius: 4px;
            background: rgba(255, 128, 0, 0.1); border: 1px solid var(--accent);
            color: var(--accent); font-weight: 900; font-family: monospace;
        }

        .warning-row td { background: rgba(255, 49, 49, 0.05) !important; }
        .delete-btn { 
            background: transparent; color: #555; border: 1px solid #333; 
            padding: 8px 12px; font-size: 10px; box-shadow: none;
        }
        .delete-btn:hover { background: #ff3131; color: white; border-color: #ff3131; box-shadow: 0 0 15px rgba(255, 49, 49, 0.3); }

        .footer { text-align: center; padding: 40px; color: #333; font-size: 10px; text-transform: uppercase; letter-spacing: 2px; }
    </style>
</head>
<body oncontextmenu="return false">

<script>
    if (sessionStorage.getItem('access_granted') !== 'true') {
        window.location.replace('index.html'); 
    }
</script>

<div class="navbar">
    <div class="nav-brand">
        <img src="semsira.png" alt="SEMSIRA">
        <h1>SEMSIRA BADAN DISIPLIN PELAJAR</h1>
    </div>
    <div style="font-size: 9px; color: var(--text-dim); letter-spacing: 1px;">DATABASE VERSION: 3.0.4A</div>
</div>

<div class="container">
    <div class="card">
        <h3>System.input_record()</h3>
        <div class="input-group">
            <input type="text" id="stuName" placeholder="NAME">
            <input type="text" id="stuClass" placeholder="CLASS">
            <select id="violation">
                <option value="" disabled selected>TYPE_OF_OFFENCE</option>
                <option value="Late">LATE</option>
                <option value="Skipping Class">SKIPPING CLASS</option>
                <option value="Bullying">BULLYING</option>
                <option value="Contraband">CONTRABAND</option>
                <option value="Severe Misconduct/Drugs">SEVERE MISCONDUCT / DRUGS</option>
                <option value="Others">OTHERS</option>
            </select>
            <button onclick="submitRecord()">Commit_Data</button>
        </div>
    </div>

    <h3>Database.query_all()</h3>
    <input type="text" id="searchBox" onkeyup="filterRecords()" placeholder="SCANNING DATABASE FOR RECORDS...">

    <table>
        <thead>
            <tr>
                <th width="25%">Student_ID</th>
                <th width="45%">Offence_Logs</th>
                <th width="15%" style="text-align:center">Counter</th>
                <th width="15%">Execution</th>
            </tr>
        </thead>
        <tbody id="recordBody">
        </tbody>
    </table>
</div>

<div class="footer">Cloud Synthesis Engine // Secured by Zijun // 2026</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, where, getDocs, arrayUnion, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqY9ADs8oy1Uvh3-7eVCQLYfyTijm8lo4",
        authDomain: "bdpsemsira-5c274.firebaseapp.com",
        projectId: "bdpsemsira-5c274",
        storageBucket: "bdpsemsira-5c274.firebasestorage.app",
        messagingSenderId: "176946808975",
        appId: "1:176946808975:web:ef7447a11bb57fe71b88fa"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "students");

    function getTagClass(offence) {
        if (offence.includes("Late")) return "tag-late";
        if (offence.includes("Skipping")) return "tag-skipping";
        if (offence.includes("Bullying")) return "tag-bullying";
        if (offence.includes("Contraband")) return "tag-contraband";
        if (offence.includes("Severe") || offence.includes("Drugs")) return "tag-drugs";
        return "tag-others";
    }

    window.submitRecord = async () => {
        const name = document.getElementById('stuName').value.trim().toUpperCase();
        const className = document.getElementById('stuClass').value.trim().toUpperCase();
        const offence = document.getElementById('violation').value;

        if (!name || !className || !offence) return alert("Missing Parameters");

        try {
            const q = query(colRef, where("name", "==", name));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const studentDoc = querySnapshot.docs[0];
                await updateDoc(doc(db, "students", studentDoc.id), {
                    offences: arrayUnion(offence),
                    counts: increment(1)
                });
            } else {
                await addDoc(colRef, {
                    name: name, class: className, offences: [offence], counts: 1
                });
            }
            document.getElementById('stuName').value = "";
            document.getElementById('violation').selectedIndex = 0;
        } catch (e) { console.error(e); }
    };

    onSnapshot(colRef, (snapshot) => {
        let html = "";
        snapshot.docs.forEach(docData => {
            const data = docData.data();
            const id = docData.id;
            let offencesHtml = data.offences.map(o => `
                <span class="offence-tag ${getTagClass(o)}">
                    ${o} <span class="remove-single" onclick="deleteSingle('${id}', '${o}')">Ã—</span>
                </span>
            `).join("");

            html += `
                <tr class="${data.counts >= 3 ? 'warning-row' : ''}">
                    <td>
                        <div style="font-weight:900; color:#fff; font-size:15px; letter-spacing:1px">${data.name}</div>
                        <div style="color:var(--text-dim); font-size:10px; margin-top:4px;">UNIT: ${data.class}</div>
                    </td>
                    <td>${offencesHtml}</td>
                    <td style="text-align:center"><span class="count-badge">${data.counts}</span></td>
                    <td><button class="delete-btn" onclick="purgeStudent('${id}')">Purge</button></td>
                </tr>
            `;
        });
        document.getElementById('recordBody').innerHTML = html;
    });

    window.deleteSingle = async (id, offence) => {
        if(confirm(`Remove entry: ${offence}?`)) {
            await updateDoc(doc(db, "students", id), {
                offences: arrayRemove(offence),
                counts: increment(-1)
            });
        }
    };

    window.purgeStudent = async (id) => {
        if(confirm("DANGER: PURGE DATA?")) {
            await deleteDoc(doc(db, "students", id));
        }
    };

    window.filterRecords = () => {
        const term = document.getElementById('searchBox').value.toLowerCase();
        const rows = document.querySelectorAll('#recordBody tr');
        rows.forEach(row => { row.style.display = row.innerText.toLowerCase().includes(term) ? "" : "none"; });
    };
</script>
</body>
</html>
