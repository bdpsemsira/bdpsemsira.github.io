<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management Panel | SEMSIRA BDP</title>
    <link rel="icon" type="image/png" href="semsira.png">
    <style>
        :root {
            --accent: #f1c40f; 
            --accent-hover: #f39c12;
            --bg: #0a0a0a;
            --card: #181818;
            --input-bg: #0f0f0f;
            --text: #ffffff;
            --text-dim: #666;
            --color-late: #ffeb3b;
            --color-skipping: #ff9800;
            --color-bullying: #f44336;
            --color-discrimination: #ff5252;
            --color-contraband: #e91e63;
            --color-drugs: #9c27b0;
            --color-others: #00d2ff;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            margin: 0; background-color: var(--bg); color: var(--text);
            display: flex; flex-direction: column; min-height: 100vh;
        }

        .navbar {
            background-color: #000; padding: 15px 40px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 2px solid #222;
        }
        .nav-brand { display: flex; align-items: center; }
        .nav-brand img { height: 45px; margin-right: 15px; filter: drop-shadow(0 0 10px rgba(241, 196, 15, 0.3)); }
        .nav-brand h1 { font-size: 20px; color: var(--accent); margin: 0; letter-spacing: 1px; font-weight: 800; text-transform: uppercase; }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; flex: 1; }

        .card {
            background: var(--card); padding: 25px; border-radius: 16px;
            margin-bottom: 25px; border: 1px solid #222;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        h3 { color: var(--accent); margin-top: 0; font-size: 13px; text-transform: uppercase; letter-spacing: 2px; border-left: 3px solid var(--accent); padding-left: 10px; margin-bottom: 20px;}

        .input-group { display: flex; gap: 12px; flex-wrap: wrap; }
        input, select { 
            background: var(--input-bg); border: 1px solid #333; color: white; 
            padding: 14px; border-radius: 8px; flex: 1; min-width: 150px; transition: 0.3s;
        }
        
        button { 
            background: var(--accent); color: black; padding: 12px 24px; border: none; 
            border-radius: 8px; cursor: pointer; font-weight: bold; text-transform: uppercase; transition: 0.3s;
        }
        button:hover:not(:disabled) { background: var(--accent-hover); transform: translateY(-2px); }
        button:disabled { background: #333; color: #666; cursor: not-allowed; }

        #searchBox { 
            width: 100%; margin-bottom: 25px; font-size: 16px; border: 1px solid #333;
            background: #000; padding: 15px 20px; border-radius: 12px; color: white;
        }

        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { color: var(--text-dim); padding: 15px; text-align: left; font-size: 11px; text-transform: uppercase; }
        td { background: #1a1a1a; padding: 18px; border-top: 1px solid #282828; border-bottom: 1px solid #282828; }
        td:first-child { border-left: 1px solid #282828; border-radius: 12px 0 0 12px; }
        td:last-child { border-right: 1px solid #282828; border-radius: 0 12px 12px 0; }
        
        .offence-tag {
            display: inline-flex; align-items: center; 
            background: #252525; padding: 6px 12px; margin: 4px; border-radius: 6px; 
            font-size: 12px; font-weight: 600; cursor: pointer; transition: 0.2s;
            border-left: 4px solid #555;
        }

        /* Pagination UI */
        .pagination-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 20px; padding: 10px; background: #000; border-radius: 12px;
        }
        .page-info { color: var(--text-dim); font-size: 13px; }

        .tag-late { border-left-color: var(--color-late) !important; color: var(--color-late); }
        .tag-bullying { border-left-color: var(--color-bullying) !important; color: var(--color-bullying); }
        .tag-discrimination { border-left-color: var(--color-discrimination) !important; color: var(--color-discrimination); }

        .delete-btn { background: #331111; color: #ff4d4d; border: 1px solid #442222; padding: 8px 16px; font-size: 11px; border-radius: 6px; }
        .footer { text-align: center; padding: 30px; color: var(--text-dim); font-size: 11px; letter-spacing: 1px; }
    </style>
</head>
<body>

<div class="navbar">
    <div class="nav-brand">
        <img src="semsira.png" alt="SEMSIRA">
        <h1>SEMSIRA BADAN DISIPLIN PELAJAR</h1>
    </div>
</div>

<div class="container">
    <div class="card">
        <h3>1. DATA ENTRY</h3>
        <div class="input-group">
            <input type="text" id="stuName" placeholder="STUDENT FULL NAME">
            <input type="text" id="stuClass" placeholder="CLASS">
            <select id="violation">
                <option value="" disabled selected>OFFENCE TYPE</option>
                <option value="Late">LATE</option>
                <option value="Bullying">BULLYING</option>
                <option value="Discrimination">DISCRIMINATION</option>
                <option value="Others">OTHERS</option>
            </select>
            <button onclick="submitRecord()">Commit Entry</button>
        </div>
    </div>

    <div class="card" style="background: transparent; border: none; padding: 0;">
        <h3>2. RECORD LOG</h3>
        <input type="text" id="searchBox" onkeyup="handleSearch()" placeholder="SEARCH BY NAME OR CLASS...">

        <table>
            <thead>
                <tr>
                    <th width="25%">Student</th>
                    <th width="45%">History</th>
                    <th width="15%" style="text-align:center">Total</th>
                    <th width="15%">Action</th>
                </tr>
            </thead>
            <tbody id="recordBody"></tbody>
        </table>

        <div class="pagination-bar">
            <button id="prevBtn" onclick="changePage(-1)">PREVIOUS</button>
            <div class="page-info" id="pageDisplay">Page 1 of 1</div>
            <button id="nextBtn" onclick="changePage(1)">NEXT PAGE</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, where, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { /* 保持你的配置不变 */ };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "students");

    let allStudents = []; // 存储所有从数据库抓取的数据
    let filteredStudents = []; // 存储搜索过滤后的数据
    let currentPage = 1;
    const pageSize = 20;

    // 监听数据库
    onSnapshot(colRef, (snapshot) => {
        allStudents = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        handleSearch(); // 初始化或数据更新时重新计算分页
    });

    window.handleSearch = () => {
        const term = document.getElementById('searchBox').value.toLowerCase();
        filteredStudents = allStudents.filter(s => 
            s.name.toLowerCase().includes(term) || s.class.toLowerCase().includes(term)
        );
        currentPage = 1; // 搜索时重置到第一页
        renderTable();
    };

    window.changePage = (direction) => {
        currentPage += direction;
        renderTable();
    };

    function renderTable() {
        const totalPages = Math.ceil(filteredStudents.length / pageSize) || 1;
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        // 计算当前页要显示的 20 个学生
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageData = filteredStudents.slice(start, end);

        // 更新按钮状态
        document.getElementById('prevBtn').disabled = (currentPage === 1);
        document.getElementById('nextBtn').disabled = (currentPage === totalPages);
        document.getElementById('pageDisplay').innerText = `Page ${currentPage} of ${totalPages} (${filteredStudents.length} entries)`;

        let html = "";
        pageData.forEach(data => {
            // ... 这里的 HTML 生成逻辑与之前版本一致 ...
            html += `<tr><td>${data.name}<br><small>${data.class}</small></td>...</tr>`; 
        });
        document.getElementById('recordBody').innerHTML = html;
        // 注意：此处为了简洁省略了具体的标签生成代码，逻辑与 v3.6 保持一致
    }

    // 这里的其它功能（submitRecord, deleteSingle 等）保持不变...
</script>
</body>
</html>
