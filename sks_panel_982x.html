window.downloadReport = async () => {
    const dateInput = document.getElementById('reportDate').value;
    if(!dateInput) return alert("Pilih tarikh!");
    
    const [y, m, d] = dateInput.split('-');
    const target = `${d}/${m}/${y}`; // 匹配格式如 26/02/2026
    const tbody = document.getElementById('reportTbody');
    const template = document.getElementById('reportExportTemplate');
    
    tbody.innerHTML = "";
    let count = 0;

    // 筛选符合日期的数据
    allData.forEach(s => {
        s.offences.forEach(o => {
            if(o.time.includes(target)) {
                count++;
                tbody.innerHTML += `
                    <tr>
                        <td style="color:#000 !important; border:1px solid #000 !important;">${s.name}</td>
                        <td style="color:#000 !important; border:1px solid #000 !important;">${s.class}</td>
                        <td style="color:#000 !important; border:1px solid #000 !important;">${o.type}</td>
                        <td style="color:#000 !important; border:1px solid #000 !important;">${o.time.split(', ')[1]}</td>
                        <td style="color:#000 !important; border:1px solid #000 !important;">${o.by}</td>
                    </tr>`;
            }
        });
    });

    if(count === 0) return alert("Tiada data pada tarikh ini.");

    // 设置报告页眉信息
    document.getElementById('rptMeta').innerText = `TARIKH: ${target} | OPERATOR: ${currentAdmin}`;
    document.getElementById('rptMeta').style.color = "#000";

    // 执行导出
    html2canvas(template, { 
        scale: 2, 
        backgroundColor: "#ffffff", // 强制白色背景
        useCORS: true,              // 允许跨域加载图片（如 logo）
        logging: false
    }).then(canvas => {
        const link = document.createElement('a');
        link.download = `Laporan_BDP_${target}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
    });
};
