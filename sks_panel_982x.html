<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Disiplin | SEMSIRA BDP</title<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Disiplin | SEMSIRA BDP (24H)</title>
    <link rel="icon" type="image/png" href="semsira.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --accent: #f1c40f; --bg: #0a0a0a; --card: #181818; --text: #ffffff;
            --tag-late: #f1c40f; --tag-skip: #e67e22; --tag-bad: #e74c3c;
            --tag-traffic: #95a5a6; --tag-other: #3498db;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--text); }
        .navbar { background: #000; padding: 15px 40px; display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #222; position: sticky; top: 0; z-index: 1000; }
        .nav-brand { display: flex; align-items: center; }
        .nav-brand img { height: 45px; margin-right: 15px; }
        .nav-brand h1 { font-size: 20px; color: var(--accent); margin: 0; }

        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; padding-bottom: 100px; }
        .card { background: var(--card); padding: 25px; border-radius: 16px; margin-bottom: 25px; border: 1px solid #222; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        h3 { margin-top: 0; font-size: 14px; color: #888; text-transform: uppercase; margin-bottom: 20px; display: flex; align-items: center; }
        h3::before { content: ""; width: 4px; height: 15px; background: var(--accent); margin-right: 10px; border-radius: 2px; }

        .input-group { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
        .field { flex: 1; min-width: 150px; }
        .field label { display: block; font-size: 10px; color: var(--accent); margin-bottom: 5px; font-weight: bold; }
        input, select { background: #0f0f0f; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; box-sizing: border-box; }
        
        .analysis-grid { display: grid; grid-template-columns: 2fr 2fr 1fr 1fr; gap: 15px; align-items: flex-end; }
        .stat-box { background: var(--accent); color: #000; padding: 10px; border-radius: 10px; text-align: center; height: 55px; display: flex; flex-direction: column; justify-content: center; font-weight: bold; }
        
        /* Error Color Tags */
        .offence-tag { display: inline-block; padding: 4px 10px; margin: 3px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; color: #000; }
        .bg-late { background-color: var(--tag-late); }
        .bg-skip { background-color: var(--tag-skip); }
        .bg-bad { background-color: var(--tag-bad); color: #fff; }
        .bg-traffic { background-color: var(--tag-traffic); }
        .bg-other { background-color: var(--tag-other); color: #fff; }

        /* Log System (Operator Highlighted) */
        .log-panel { background: #050505; border: 1px solid #222; height: 150px; overflow-y: auto; padding: 15px; font-family: 'Courier New', monospace; font-size: 12px; border-radius: 12px; }
        .log-entry { padding: 5px 0; border-bottom: 1px solid #111; display: flex; justify-content: space-between; }
        .log-time { color: #555; }
        .log-msg { color: #bbb; flex: 1; margin: 0 15px; }
        .log-admin { color: var(--accent); font-weight: bold; padding: 0 5px; background: rgba(241, 196, 15, 0.1); border-radius: 4px; }

        /* Table & Pagination */
        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        td { background: #1e1e1e; padding: 15px; border-top: 1px solid #282828; border-bottom: 1px solid #282828; }
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .page-btn { background: #222; color: #888; border: 1px solid #333; padding: 5px 12px; border-radius: 5px; cursor: pointer; }
        .page-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

        button { background: var(--accent); color: black; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-download { background: #27ae60; color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); }

        .modal { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .modal-content { background:#181818; padding:25px; border-radius:16px; width:450px; border: 1px solid #333; }

        /* Export Template */
        #exportTemplate { position: absolute; left: -9999px; width: 850px; background: white; color: black; padding: 50px; }
        #exportTemplate * { color: black !important; border-color: black !important; }
        .rpt-header { display: flex; align-items: center; border-bottom: 4px double black; padding-bottom: 15px; margin-bottom: 25px; }
        .rpt-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .rpt-table th, .rpt-table td { border: 1px solid black; padding: 12px; text-align: left; font-size: 13px; }
        .sig-area { margin-top: 80px; display: flex; justify-content: flex-end; text-align: center; }
    </style>
</head>
<body>

<div class="navbar">
    <div class="nav-brand"><img src="semsira.png" alt="Logo"><h1>SEMSIRA BDP</h1></div>
    <div style="text-align:right">
        <div style="font-size:12px; font-weight:bold;">OPERATOR: <span id="displayAdmin" style="color:var(--accent)">...</span></div>
        <div style="font-size:10px; color:#27ae60;">24-HOUR MODE ACTIVE</div>
    </div>
</div>

<div class="container">
    
    <div class="card">
        <h3>1. Rekod Kemasukan Pelajar</h3>
        <div class="input-group">
            <div class="field" style="flex:1.5"><label>NAMA PENUH</label><input type="text" id="stuName" placeholder="Contoh: MUHAMMAD ALI"></div>
            <div class="field" style="flex:0.5"><label>KELAS</label><input type="text" id="stuClass" placeholder="5A"></div>
            <div class="field" style="flex:0.5"><label>WAKTU (24H)</label><input type="time" id="violationTime"></div>
            <div class="field" style="flex:1.2">
                <label>JENIS KESALAHAN</label>
                <select id="violation">
                    <option value="" disabled selected>Sila Pilih...</option>
                    <option value="Lewat">Lewat</option>
                    <option value="Ponteng Kelas">Ponteng Kelas</option>
                    <option value="Buli">Buli</option>
                    <option value="Bergaduh">Bergaduh</option>
                    <option value="Barang Larangan">Barang Larangan</option>
                    <option value="Salah Guna Dadah/Merokok">Salah Guna Dadah/Merokok</option>
                    <option value="Isu Trafik">Isu Trafik</option>
                    <option value="Lain-lain">Lain-lain</option>
                </select>
            </div>
            <button onclick="submitRecord()">SIMPAN REKOD</button>
        </div>
    </div>

    <div class="card">
        <h3>2. Analisis & Eksport Laporan Bulanan</h3>
        <div class="analysis-grid">
            <div class="field"><label>PILIH BULAN</label><input type="month" id="monthPicker" onchange="updateAnalysis()"></div>
            <div class="field"><label>TAPIS KESALAHAN</label>
                <select id="filterType" onchange="updateAnalysis()">
                    <option value="SEMUA">SEMUA KESALAHAN</option>
                    <option value="Lewat">Lewat</option>
                    <option value="Ponteng Kelas">Ponteng Kelas</option>
                    <option value="Buli">Buli</option>
                    <option value="Bergaduh">Bergaduh</option>
                    <option value="Barang Larangan">Barang Larangan</option>
                    <option value="Salah Guna Dadah/Merokok">Salah Guna Dadah/Merokok</option>
                    <option value="Isu Trafik">Isu Trafik</option>
                    <option value="Lain-lain">Lain-lain</option>
                </select>
            </div>
            <div class="stat-box">
                <div style="font-size:9px;">BIL. KES</div>
                <div id="totalCaseCount" style="font-size:22px">0</div>
            </div>
            <button onclick="downloadFilteredReport()" class="btn-download" style="height:55px">EXPORT PNG</button>
        </div>
    </div>

    <div class="card" style="background:transparent; border:none; padding:0; box-shadow:none;">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:15px;">
            <h3 style="margin:0">3. Rekod Disiplin Terkumpul</h3>
            <button onclick="downloadStudentProfile()" id="btnDownloadProfile" class="btn-outline" style="display:none;">DOWNLOAD PROFIL PELAJAR</button>
        </div>
        <input type="text" id="searchBox" onkeyup="handleSearch()" placeholder="Cari nama pelajar...">
        
        <table>
            <tbody id="recordBody"></tbody>
        </table>
        <div id="pagination" class="pagination"></div>
    </div>

    <div class="card">
        <h3>4. Log Aktiviti Operator</h3>
        <div class="log-panel" id="logDisplay"></div>
    </div>
</div>

<div id="historyModal" class="modal">
    <div class="modal-content">
        <h4 id="modalTitle" style="margin-top:0; color:var(--accent);"></h4>
        <div id="historyList"></div>
        <button onclick="closeModal()" style="width:100%; margin-top:20px; background:#333; color:white;">TUTUP</button>
    </div>
</div>

<div id="exportTemplate">
    <div class="rpt-header">
        <img src="semsira.png" style="height:80px; margin-right:25px;">
        <div>
            <h1 style="margin:0;">LAPORAN DISIPLIN SEMSIRA</h1>
            <p id="rptSubTitle" style="margin:5px 0; font-weight:bold;"></p>
        </div>
    </div>
    <div id="rptContent"></div>
    <div class="sig-area">
        <div>
            <p>___________________________</p>
            <p style="font-weight:bold; margin:0;">Tandatangan Pegawai</p>
            <p id="rptAdminName" style="font-size:13px;"></p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, where, getDocs, increment, writeBatch, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqY9ADs8oy1Uvh3-7eVCQLYfyTijm8lo4",
        authDomain: "bdpsemsira-5c274.firebaseapp.com",
        projectId: "bdpsemsira-5c274",
        storageBucket: "bdpsemsira-5c274.firebasestorage.app",
        messagingSenderId: "176946808975",
        appId: "1:176946808975:web:ef7447a11bb57fe71b88fa"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "students");
    const logRef = collection(db, "logs");

    const currentAdmin = sessionStorage.getItem('admin_name') || "OPERATOR";
    document.getElementById('displayAdmin').innerText = currentAdmin;
    document.getElementById('monthPicker').value = new Date().toISOString().slice(0, 7);

    let allData = [];
    let currentPage = 1;
    const rowsPerPage = 7;
    let selectedStudentForReport = null;

    onSnapshot(colRef, (snap) => {
        allData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        render();
        updateAnalysis();
    });

    onSnapshot(query(logRef, orderBy("timestamp", "desc"), limit(12)), (snap) => {
        let html = "";
        snap.forEach(d => {
            const data = d.data();
            const time = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString('ms-MY', {hour12: false, hour:'2-digit', minute:'2-digit'}) : "...";
            html += `<div class="log-entry"><span class="log-time">[${time}]</span><span class="log-msg">${data.msg}</span><span class="log-admin">${data.admin}</span></div>`;
        });
        document.getElementById('logDisplay').innerHTML = html;
    });

    async function sysLog(msg) { await addDoc(logRef, { msg, admin: currentAdmin, timestamp: serverTimestamp() }); }

    window.submitRecord = async () => {
        const name = document.getElementById('stuName').value.trim().toUpperCase();
        const cls = document.getElementById('stuClass').value.trim().toUpperCase();
        const type = document.getElementById('violation').value;
        const time = document.getElementById('violationTime').value; // HH:mm format
        
        if(!name || !cls || !type || !time) return alert("Sila lengkapkan maklumat!");

        const today = new Date().toLocaleDateString('en-GB');
        const monthKey = new Date().toISOString().slice(0, 7);
        const entry = { type, time: `${today}, ${time}`, by: currentAdmin, month: monthKey };
        
        const q = query(colRef, where("name", "==", name), where("class", "==", cls));
        const qs = await getDocs(q);
        if(!qs.empty) {
            await updateDoc(doc(db, "students", qs.docs[0].id), { offences: [...qs.docs[0].data().offences, entry], counts: increment(1) });
        } else {
            await addDoc(colRef, { name, class: cls, offences: [entry], counts: 1 });
        }
        await sysLog(`TAMBAH: ${type} - ${name}`);
        document.getElementById('stuName').value = "";
    };

    function getColorClass(type) {
        if(type === "Lewat") return "bg-late";
        if(type === "Ponteng Kelas") return "bg-skip";
        if(["Buli", "Bergaduh"].includes(type)) return "bg-bad";
        if(type.includes("Trafik")) return "bg-traffic";
        return "bg-other";
    }

    window.updateAnalysis = () => {
        const selMonth = document.getElementById('monthPicker').value;
        const selType = document.getElementById('filterType').value;
        let count = 0;
        allData.forEach(s => {
            s.offences.forEach(o => {
                if(o.month === selMonth && (selType === "SEMUA" || o.type === selType)) count++;
            });
        });
        document.getElementById('totalCaseCount').innerText = count;
    };

    window.handleSearch = () => { currentPage = 1; render(); };

    function render() {
        const term = document.getElementById('searchBox').value.toUpperCase();
        const filtered = allData.filter(s => s.name.includes(term));
        
        const btn = document.getElementById('btnDownloadProfile');
        if(term.length > 3 && filtered.length === 1) {
            btn.style.display = "block";
            selectedStudentForReport = filtered[0];
        } else {
            btn.style.display = "none";
            selectedStudentForReport = null;
        }

        const startIndex = (currentPage - 1) * rowsPerPage;
        const pagedData = filtered.slice(startIndex, startIndex + rowsPerPage);
        
        let html = "";
        pagedData.forEach(s => {
            const tags = s.offences.map(o => `<span class="offence-tag ${getColorClass(o.type)}" onclick="viewHistory('${s.id}')">${o.type}</span>`).join('');
            html += `<tr><td style="width:30%"><b>${s.name}</b><br><small style="color:var(--accent)">${s.class}</small></td><td>${tags}</td><td style="text-align:right"><button onclick="viewHistory('${s.id}')" style="background:#333; color:white; font-size:10px;">SEJARAH</button></td></tr>`;
        });
        document.getElementById('recordBody').innerHTML = html || "<tr><td colspan='3' style='text-align:center'>Tiada rekod.</td></tr>";
        renderPagination(filtered.length);
    }

    function renderPagination(total) {
        const pages = Math.ceil(total / rowsPerPage);
        let html = "";
        for(let i=1; i<=pages; i++) html += `<button class="page-btn ${i===currentPage?'active':''}" onclick="changePage(${i})">${i}</button>`;
        document.getElementById('pagination').innerHTML = html;
    }
    window.changePage = (p) => { currentPage = p; render(); };

    window.viewHistory = (id) => {
        const s = allData.find(x => x.id === id);
        document.getElementById('modalTitle').innerText = s.name;
        document.getElementById('historyList').innerHTML = s.offences.map((o, i) => `
            <div style="padding:10px; border-bottom:1px solid #222; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:12px;">${o.time} | <b>${o.type}</b></span>
                <button onclick="delEntry('${id}', ${i})" style="background:#442222; color:red; font-size:9px;">HAPUS</button>
            </div>`).join('');
        document.getElementById('historyModal').style.display = "flex";
    };

    window.delEntry = async (id, idx) => {
        if(!confirm("Padam?")) return;
        const s = allData.find(x => x.id === id);
        let updated = [...s.offences];
        updated.splice(idx, 1);
        if(updated.length === 0) await deleteDoc(doc(db, "students", id));
        else await updateDoc(doc(db, "students", id), { offences: updated, counts: updated.length });
        closeModal();
    };
    window.closeModal = () => document.getElementById('historyModal').style.display = "none";

    window.downloadFilteredReport = () => {
        const selMonth = document.getElementById('monthPicker').value;
        const selType = document.getElementById('filterType').value;
        const [y, m] = selMonth.split('-');
        document.getElementById('rptSubTitle').innerText = `LAPORAN: ${selType.toUpperCase()} (${m}/${y})`;
        document.getElementById('rptAdminName').innerText = `Oleh: ${currentAdmin}`;
        let rows = ""; let count = 0;
        allData.forEach(s => { s.offences.forEach(o => {
            if(o.month === selMonth && (selType === "SEMUA" || o.type === selType)) {
                count++; rows += `<tr><td>${count}</td><td>${s.name}</td><td>${s.class}</td><td>${o.type}</td><td>${o.time}</td></tr>`;
            }
        }); });
        if(count === 0) return alert("Tiada data.");
        document.getElementById('rptContent').innerHTML = `<table class="rpt-table"><thead><tr><th>No</th><th>Nama</th><th>Kelas</th><th>Jenis</th><th>Masa (24H)</th></tr></thead><tbody>${rows}</tbody></table>`;
        capture(`Laporan_${selType}_${m}_${y}`);
    };

    window.downloadStudentProfile = () => {
        const s = selectedStudentForReport;
        document.getElementById('rptSubTitle').innerText = `PROFIL DISIPLIN: ${s.name}`;
        document.getElementById('rptAdminName').innerText = `Pegawai: ${currentAdmin}`;
        let rows = s.offences.map((o, idx) => `<tr><td>${idx+1}</td><td>${o.time}</td><td>${o.type}</td><td>${o.by}</td></tr>`).join('');
        document.getElementById('rptContent').innerHTML = `<div style="margin-bottom:10px"><b>KELAS: ${s.class} | JUMLAH KES: ${s.counts}</b></div><table class="rpt-table"><thead><tr><th>No</th><th>Tarikh/Masa (24H)</th><th>Kesalahan</th><th>Pegawai</th></tr></thead><tbody>${rows}</tbody></table>`;
        capture(`Profil_${s.name}`);
    };

    function capture(filename) {
        html2canvas(document.getElementById('exportTemplate'), { backgroundColor: "#ffffff", scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = filename + ".png";
            link.href = canvas.toDataURL();
            link.click();
        });
    }
</script>
</body>
</html>
    <link rel="icon" type="image/png" href="semsira.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --accent: #f1c40f; 
            --bg: #0a0a0a; 
            --card: #181818; 
            --text: #ffffff;
            --tag-late: #f1c40f;    /* Kuning */
            --tag-skip: #e67e22;    /* Jingga */
            --tag-bad: #e74c3c;     /* Merah */
            --tag-traffic: #95a5a6; /* Kelabu */
            --tag-other: #3498db;   /* Biru */
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); color: var(--text); line-height: 1.6; }
        
        /* Navbar */
        .navbar { background: #000; padding: 15px 40px; display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #222; position: sticky; top: 0; z-index: 1000; }
        .nav-brand { display: flex; align-items: center; }
        .nav-brand img { height: 45px; margin-right: 15px; }
        .nav-brand h1 { font-size: 20px; color: var(--accent); margin: 0; letter-spacing: 1px; }

        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; padding-bottom: 100px; }
        
        /* Cards */
        .card { background: var(--card); padding: 25px; border-radius: 16px; margin-bottom: 25px; border: 1px solid #222; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        h3 { margin-top: 0; font-size: 14px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; display: flex; align-items: center; }
        h3::before { content: ""; width: 4px; height: 15px; background: var(--accent); margin-right: 10px; border-radius: 2px; }

        /* Inputs */
        .input-group { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
        .field { flex: 1; min-width: 150px; }
        .field label { display: block; font-size: 10px; color: var(--accent); margin-bottom: 5px; font-weight: bold; }
        input, select { background: #0f0f0f; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; box-sizing: border-box; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--accent); background: #151515; }
        
        /* Analysis Panel */
        .analysis-grid { display: grid; grid-template-columns: 2fr 2fr 1fr 1fr; gap: 15px; align-items: flex-end; }
        .stat-box { background: var(--accent); color: #000; padding: 10px; border-radius: 10px; text-align: center; height: 55px; display: flex; flex-direction: column; justify-content: center; }
        
        /* Tags UI */
        .offence-tag { display: inline-block; padding: 4px 10px; margin: 3px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; color: #000; transition: transform 0.2s; }
        .offence-tag:hover { transform: scale(1.05); }
        .bg-late { background-color: var(--tag-late); }
        .bg-skip { background-color: var(--tag-skip); }
        .bg-bad { background-color: var(--tag-bad); color: #fff; }
        .bg-traffic { background-color: var(--tag-traffic); }
        .bg-other { background-color: var(--tag-other); color: #fff; }

        /* Log System (Operator Highlighted) */
        .log-panel { background: #050505; border: 1px solid #222; height: 150px; overflow-y: auto; padding: 15px; font-family: 'Courier New', monospace; font-size: 12px; border-radius: 12px; }
        .log-entry { padding: 5px 0; border-bottom: 1px solid #111; display: flex; justify-content: space-between; }
        .log-time { color: #555; }
        .log-msg { color: #bbb; flex: 1; margin: 0 15px; }
        .log-admin { color: var(--accent); font-weight: bold; padding: 0 5px; background: rgba(241, 196, 15, 0.1); border-radius: 4px; }

        /* Table & Pagination */
        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        td { background: #1e1e1e; padding: 15px; border-top: 1px solid #282828; border-bottom: 1px solid #282828; transition: 0.3s; }
        tr:hover td { background: #252525; }
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .page-btn { background: #222; color: #888; border: 1px solid #333; padding: 5px 12px; border-radius: 5px; cursor: pointer; }
        .page-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

        /* Buttons */
        button { background: var(--accent); color: black; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { opacity: 0.8; transform: translateY(-1px); }
        .btn-download { background: #27ae60; color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
        .btn-del { background: #2c0a0a; color: #ff4d4d; font-size: 10px; border: 1px solid #5a1010; }

        /* Modal */
        .modal { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .modal-content { background:#181818; padding:25px; border-radius:16px; width:450px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* Export Template (Always White) */
        #exportTemplate { position: absolute; left: -9999px; width: 850px; background: white; color: black; padding: 50px; }
        #exportTemplate * { color: black !important; border-color: black !important; }
        .rpt-header { display: flex; align-items: center; border-bottom: 4px double black; padding-bottom: 15px; margin-bottom: 25px; }
        .rpt-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .rpt-table th, .rpt-table td { border: 1px solid black; padding: 12px; text-align: left; font-size: 13px; }
        .sig-area { margin-top: 80px; display: flex; justify-content: flex-end; text-align: center; }
    </style>
</head>
<body>

<div class="navbar">
    <div class="nav-brand"><img src="semsira.png" alt="Logo"><h1>SEMSIRA BDP</h1></div>
    <div style="text-align:right">
        <div style="font-size:12px; font-weight:bold;">OPERATOR: <span id="displayAdmin" style="color:var(--accent)">...</span></div>
        <div style="font-size:10px; color:#27ae60; text-transform:uppercase">System Security Active</div>
    </div>
</div>

<div class="container">
    
    <div class="card">
        <h3>1. Rekod Kemasukan Pelajar</h3>
        <div class="input-group">
            <div class="field" style="flex:1.5"><label>NAMA PENUH</label><input type="text" id="stuName" placeholder="Contoh: MUHAMMAD ALI"></div>
            <div class="field" style="flex:0.5"><label>KELAS</label><input type="text" id="stuClass" placeholder="5A"></div>
            <div class="field" style="flex:0.5"><label>WAKTU</label><input type="time" id="violationTime"></div>
            <div class="field" style="flex:1.2">
                <label>JENIS KESALAHAN</label>
                <select id="violation">
                    <option value="" disabled selected>Sila Pilih...</option>
                    <option value="Lewat">Lewat</option>
                    <option value="Ponteng Kelas">Ponteng Kelas</option>
                    <option value="Buli">Buli</option>
                    <option value="Bergaduh">Bergaduh</option>
                    <option value="Barang Larangan">Barang Larangan</option>
                    <option value="Salah Guna Dadah/Merokok">Salah Guna Dadah/Merokok</option>
                    <option value="Isu Trafik">Isu Trafik</option>
                    <option value="Lain-lain">Lain-lain</option>
                </select>
            </div>
            <button onclick="submitRecord()">SIMPAN REKOD</button>
        </div>
    </div>

    <div class="card">
        <h3>2. Analisis & Eksport Laporan Bulanan</h3>
        <div class="analysis-grid">
            <div class="field"><label>PILIH BULAN</label><input type="month" id="monthPicker" onchange="updateAnalysis()"></div>
            <div class="field"><label>TAPIS KESALAHAN</label>
                <select id="filterType" onchange="updateAnalysis()">
                    <option value="SEMUA">SEMUA KESALAHAN</option>
                    <option value="Lewat">Lewat</option>
                    <option value="Ponteng Kelas">Ponteng Kelas</option>
                    <option value="Buli">Buli</option>
                    <option value="Bergaduh">Bergaduh</option>
                    <option value="Barang Larangan">Barang Larangan</option>
                    <option value="Salah Guna Dadah/Merokok">Salah Guna Dadah/Merokok</option>
                    <option value="Isu Trafik">Isu Trafik</option>
                    <option value="Lain-lain">Lain-lain</option>
                </select>
            </div>
            <div class="stat-box">
                <div style="font-size:9px; font-weight:bold">JUMLAH KES</div>
                <div id="totalCaseCount" style="font-size:22px">0</div>
            </div>
            <button onclick="downloadFilteredReport()" class="btn-download" style="height:55px">EXPORT PNG</button>
        </div>
    </div>

    <div class="card" style="background:transparent; border:none; padding:0; box-shadow:none;">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:15px;">
            <h3 style="margin:0">3. Rekod Disiplin Terkumpul</h3>
            <button onclick="downloadStudentProfile()" id="btnDownloadProfile" class="btn-outline" style="display:none; padding:8px 15px; font-size:12px;">DOWNLOAD PROFIL PELAJAR</button>
        </div>
        <input type="text" id="searchBox" onkeyup="handleSearch()" placeholder="Cari nama pelajar untuk sejarah atau muat turun profil...">
        
        <table id="mainTable">
            <tbody id="recordBody"></tbody>
        </table>

        <div id="pagination" class="pagination"></div>
    </div>

    <div class="card">
        <h3>4. Log Aktiviti Operator (Sesi Semasa)</h3>
        <div class="log-panel" id="logDisplay"></div>
    </div>

    <div style="text-align:center; opacity:0.3; font-size:10px; margin-top:20px;">
        SEMSIRA BDP MONITORING SYSTEM &copy; 2026 | <span onclick="masterReset()" style="cursor:pointer">RESET SYSTEM</span>
    </div>
</div>

<div id="historyModal" class="modal">
    <div class="modal-content">
        <h4 id="modalTitle" style="margin-top:0; color:var(--accent); border-bottom:1px solid #333; padding-bottom:10px;"></h4>
        <div id="historyList" style="max-height:350px; overflow-y:auto; margin-top:10px;"></div>
        <button onclick="closeModal()" style="width:100%; margin-top:20px; background:#333; color:white;">TUTUP</button>
    </div>
</div>

<div id="exportTemplate">
    <div class="rpt-header">
        <img src="semsira.png" style="height:80px; margin-right:25px;">
        <div>
            <h1 style="margin:0; font-size:24px;">LAPORAN DISIPLIN SEMSIRA BDP</h1>
            <p id="rptSubTitle" style="margin:5px 0; font-weight:bold; font-size:15px;"></p>
        </div>
    </div>
    <div id="rptContent"></div>
    <div class="sig-area">
        <div>
            <p>___________________________</p>
            <p style="font-weight:bold; margin:0;">Tandatangan Pegawai</p>
            <p id="rptAdminName" style="font-size:13px; margin:5px 0 0 0;"></p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, where, getDocs, increment, writeBatch, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqY9ADs8oy1Uvh3-7eVCQLYfyTijm8lo4",
        authDomain: "bdpsemsira-5c274.firebaseapp.com",
        projectId: "bdpsemsira-5c274",
        storageBucket: "bdpsemsira-5c274.firebasestorage.app",
        messagingSenderId: "176946808975",
        appId: "1:176946808975:web:ef7447a11bb57fe71b88fa"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "students");
    const logRef = collection(db, "logs");

    const currentAdmin = sessionStorage.getItem('admin_name') || "OPERATOR";
    document.getElementById('displayAdmin').innerText = currentAdmin;
    document.getElementById('monthPicker').value = new Date().toISOString().slice(0, 7);

    let allData = [];
    let currentPage = 1;
    const rowsPerPage = 7;
    let selectedStudentForReport = null;

    // --- Data Sync ---
    onSnapshot(colRef, (snap) => {
        allData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        render();
        updateAnalysis();
    });

    onSnapshot(query(logRef, orderBy("timestamp", "desc"), limit(12)), (snap) => {
        let html = "";
        snap.forEach(d => {
            const data = d.data();
            const time = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString('ms-MY', {hour:'2-digit', minute:'2-digit'}) : "...";
            html += `<div class="log-entry">
                <span class="log-time">[${time}]</span>
                <span class="log-msg">${data.msg}</span>
                <span class="log-admin">${data.admin}</span>
            </div>`;
        });
        document.getElementById('logDisplay').innerHTML = html || "Tiada aktiviti dikesan.";
    });

    async function sysLog(msg) { await addDoc(logRef, { msg, admin: currentAdmin, timestamp: serverTimestamp() }); }

    // --- Business Logic ---
    window.submitRecord = async () => {
        const name = document.getElementById('stuName').value.trim().toUpperCase();
        const cls = document.getElementById('stuClass').value.trim().toUpperCase();
        const type = document.getElementById('violation').value;
        const time = document.getElementById('violationTime').value;
        
        if(!name || !cls || !type || !time) return alert("Sila isi semua maklumat!");

        const today = new Date().toLocaleDateString('en-GB');
        const monthKey = new Date().toISOString().slice(0, 7);
        const entry = { type, time: `${today}, ${time}`, by: currentAdmin, month: monthKey };
        
        const q = query(colRef, where("name", "==", name), where("class", "==", cls));
        const qs = await getDocs(q);
        
        if(!qs.empty) {
            await updateDoc(doc(db, "students", qs.docs[0].id), { offences: [...qs.docs[0].data().offences, entry], counts: increment(1) });
        } else {
            await addDoc(colRef, { name, class: cls, offences: [entry], counts: 1 });
        }
        
        await sysLog(`INPUT: ${type} untuk ${name}`);
        document.getElementById('stuName').value = "";
        document.getElementById('violationTime').value = "";
    };

    function getColorClass(type) {
        if(type === "Lewat") return "bg-late";
        if(type === "Ponteng Kelas") return "bg-skip";
        if(["Buli", "Bergaduh"].includes(type)) return "bg-bad";
        if(type.includes("Trafik")) return "bg-traffic";
        return "bg-other";
    }

    window.updateAnalysis = () => {
        const selMonth = document.getElementById('monthPicker').value;
        const selType = document.getElementById('filterType').value;
        let count = 0;
        allData.forEach(s => {
            s.offences.forEach(o => {
                if(o.month === selMonth && (selType === "SEMUA" || o.type === selType)) count++;
            });
        });
        document.getElementById('totalCaseCount').innerText = count;
    };

    // --- Rendering & Pagination ---
    window.handleSearch = () => { currentPage = 1; render(); };

    function render() {
        const term = document.getElementById('searchBox').value.toUpperCase();
        const filtered = allData.filter(s => s.name.includes(term));
        
        // Show profile button if exact match
        const btn = document.getElementById('btnDownloadProfile');
        if(term.length > 3 && filtered.length === 1) {
            btn.style.display = "block";
            selectedStudentForReport = filtered[0];
        } else {
            btn.style.display = "none";
            selectedStudentForReport = null;
        }

        const startIndex = (currentPage - 1) * rowsPerPage;
        const pagedData = filtered.slice(startIndex, startIndex + rowsPerPage);
        
        let html = "";
        pagedData.forEach(s => {
            const tags = s.offences.map(o => `<span class="offence-tag ${getColorClass(o.type)}" onclick="viewHistory('${s.id}')">${o.type}</span>`).join('');
            html += `<tr>
                <td style="border-radius:12px 0 0 12px; width:30%"><b>${s.name}</b><br><small style="color:var(--accent)">${s.class}</small></td>
                <td>${tags}</td>
                <td style="text-align:right; border-radius:0 12px 12px 0; width:15%">
                    <button onclick="viewHistory('${s.id}')" style="background:#333; color:white; font-size:10px; padding:6px 12px;">URUS</button>
                </td>
            </tr>`;
        });
        
        document.getElementById('recordBody').innerHTML = html || "<tr><td colspan='3' style='text-align:center; color:#555'>Tiada rekod ditemui.</td></tr>";
        renderPagination(filtered.length);
    }

    function renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / rowsPerPage);
        let html = "";
        for(let i=1; i<=totalPages; i++) {
            html += `<button class="page-btn ${i===currentPage?'active':''}" onclick="changePage(${i})">${i}</button>`;
        }
        document.getElementById('pagination').innerHTML = html;
    }

    window.changePage = (p) => { currentPage = p; render(); };

    // --- History Modal ---
    window.viewHistory = (id) => {
        const s = allData.find(x => x.id === id);
        document.getElementById('modalTitle').innerText = s.name;
        document.getElementById('historyList').innerHTML = s.offences.map((o, i) => `
            <div style="padding:12px; border-bottom:1px solid #222; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:13px;">${o.time}<br><b style="color:var(--accent)">${o.type}</b></span>
                <button class="btn-del" onclick="delEntry('${id}', ${i})">HAPUS</button>
            </div>`).join('');
        document.getElementById('historyModal').style.display = "flex";
    };

    window.delEntry = async (id, idx) => {
        if(!confirm("Padam rekod ini?")) return;
        const s = allData.find(x => x.id === id);
        let updated = [...s.offences];
        const removed = updated.splice(idx, 1)[0];
        if(updated.length === 0) await deleteDoc(doc(db, "students", id));
        else await updateDoc(doc(db, "students", id), { offences: updated, counts: updated.length });
        await sysLog(`PADAM: ${removed.type} - ${s.name}`);
        closeModal();
    };

    window.closeModal = () => document.getElementById('historyModal').style.display = "none";

    // --- Reports ---
    window.downloadFilteredReport = () => {
        const selMonth = document.getElementById('monthPicker').value;
        const selType = document.getElementById('filterType').value;
        const [y, m] = selMonth.split('-');
        
        document.getElementById('rptSubTitle').innerText = `LAPORAN KES DISIPLIN: ${selType.toUpperCase()} (${m}/${y})`;
        document.getElementById('rptAdminName').innerText = `Disediakan oleh: ${currentAdmin}`;
        
        let rows = "";
        let count = 0;
        allData.forEach(s => {
            s.offences.forEach(o => {
                if(o.month === selMonth && (selType === "SEMUA" || o.type === selType)) {
                    count++;
                    rows += `<tr><td>${count}</td><td>${s.name}</td><td>${s.class}</td><td>${o.type}</td><td>${o.time}</td></tr>`;
                }
            });
        });

        if(count === 0) return alert("Tiada data untuk bulan ini.");
        document.getElementById('rptContent').innerHTML = `<table class="rpt-table"><thead><tr><th>No</th><th>Nama</th><th>Kelas</th><th>Jenis</th><th>Waktu/Tarikh</th></tr></thead><tbody>${rows}</tbody></table>`;
        capture(`Laporan_${selType}_${m}_${y}`);
    };

    window.downloadStudentProfile = () => {
        if(!selectedStudentForReport) return;
        const s = selectedStudentForReport;
        document.getElementById('rptSubTitle').innerText = `PROFIL DISIPLIN PELAJAR (SULIT)`;
        document.getElementById('rptAdminName').innerText = `Pegawai BDP: ${currentAdmin}`;
        let rows = s.offences.map((o, idx) => `<tr><td>${idx+1}</td><td>${o.time}</td><td>${o.type}</td><td>${o.by}</td></tr>`).join('');
        document.getElementById('rptContent').innerHTML = `
            <div style="margin-bottom:15px; border:2px solid black; padding:15px;">
                <p style="margin:2px"><b>NAMA:</b> ${s.name}</p>
                <p style="margin:2px"><b>KELAS:</b> ${s.class}</p>
                <p style="margin:2px"><b>JUMLAH REKOD:</b> ${s.counts}</p>
            </div>
            <table class="rpt-table"><thead><tr><th>No</th><th>Tarikh/Masa</th><th>Jenis</th><th>Direkod Oleh</th></tr></thead><tbody>${rows}</tbody></table>`;
        capture(`Profil_${s.name.replace(/\s/g, '_')}`);
    };

    function capture(filename) {
        const el = document.getElementById('exportTemplate');
        html2canvas(el, { backgroundColor: "#ffffff", scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = filename + ".png";
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    window.masterReset = async () => {
        if(confirm("AWAS: Padam SEMUA data?") && prompt("Sila taip 'RESET2026':") === "RESET2026") {
            const b = writeBatch(db);
            const qs = await getDocs(colRef);
            qs.forEach(d => b.delete(d.ref));
            await b.commit();
            await sysLog("MASTER RESET DILAKUKAN");
            alert("Sistem dikosongkan.");
        }
    };
</script>
</body>
</html>
