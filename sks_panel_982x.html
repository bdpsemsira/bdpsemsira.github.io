<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management Panel | SEMSIRA BDP</title>
    <link rel="icon" type="image/png" href="semsira.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --accent: #f1c40f; 
            --accent-hover: #f39c12;
            --bg: #0a0a0a;
            --card: #181818;
            --input-bg: #0f0f0f;
            --text: #ffffff;
            --text-dim: #666;
        }

        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }
        .navbar { background: #000; padding: 15px 40px; display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #222; }
        .nav-brand { display: flex; align-items: center; }
        .nav-brand img { height: 40px; margin-right: 15px; }
        .nav-brand h1 { font-size: 18px; color: var(--accent); margin: 0; text-transform: uppercase; letter-spacing: 1px; }
        .admin-name { color: var(--accent); font-weight: bold; border: 1px solid #333; padding: 2px 8px; border-radius: 4px; margin-left: 5px; font-size: 12px; }

        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; flex: 1; }
        .card { background: var(--card); padding: 25px; border-radius: 16px; margin-bottom: 25px; border: 1px solid #222; }
        h3 { color: var(--accent); font-size: 12px; text-transform: uppercase; border-left: 3px solid var(--accent); padding-left: 10px; margin-bottom: 20px; }
        
        .input-group { display: flex; gap: 12px; flex-wrap: wrap; }
        input, select { background: var(--input-bg); border: 1px solid #333; color: white; padding: 14px; border-radius: 8px; flex: 1; min-width: 160px; outline: none; }
        
        #searchBox { width: 100%; box-sizing: border-box; margin-bottom: 20px; font-size: 15px; border: 1px solid #333; background: #000; padding: 15px 20px; border-radius: 12px; color: white; outline: none; }
        #searchBox:focus { border-color: var(--accent); }

        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; table-layout: fixed; }
        th { color: var(--text-dim); padding: 10px 15px; text-align: left; font-size: 11px; }
        td { background: #1a1a1a; padding: 18px; border-top: 1px solid #282828; border-bottom: 1px solid #282828; }
        td:first-child { border-radius: 12px 0 0 12px; }
        td:last-child { border-radius: 0 12px 12px 0; }

        .offence-tag { display: inline-block; background: #252525; padding: 5px 10px; margin: 3px; border-radius: 5px; font-size: 11px; border-left: 3px solid #555; }
        .count-badge { color: var(--accent); padding: 6px 14px; border-radius: 8px; border: 1px solid var(--accent); font-weight: 800; }
        
        button { background: var(--accent); color: black; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        .delete-btn { background: #221111; color: #ff4d4d; border: 1px solid #442222; padding: 8px 16px; font-size: 10px; }
        .report-btn { background: #27ae60; color: white; }
        .master-btn { background: #1a0000; color: #ff4d4d; border: 1px solid #442222; font-size: 10px; }

        .action-bar { display: flex; justify-content: flex-end; align-items: center; gap: 15px; margin-top: 50px; padding: 20px; border-top: 1px solid #222; }

        /* 导出模板样式 */
        #reportExportTemplate { position: absolute; left: -9999px; width: 1000px; background: #fff !important; color: #000 !important; padding: 50px; box-sizing: border-box; }
        .rpt-table { width: 100%; border-collapse: collapse; background: #fff !important; margin-top: 20px; }
        .rpt-table th, .rpt-table td { border: 1px solid #000 !important; padding: 12px; text-align: center; color: #000 !important; font-size: 15px; }
        
        /* 导出颜色类 */
        .c-late { color: #b7950b !important; font-weight: bold; }
        .c-skip { color: #d35400 !important; font-weight: bold; }
        .c-bad { color: #c0392b !important; font-weight: bold; }
        .c-contraband { color: #9b59b6 !important; font-weight: bold; }
        .c-drug { color: #8e44ad !important; font-weight: bold; }
    </style>
</head>
<body>

<div class="navbar">
    <div class="nav-brand"><img src="semsira.png" alt="Logo"><h1>SEMSIRA BDP</h1></div>
    <div id="adminTag">OPERATOR: <span class="admin-name" id="displayAdmin">...</span></div>
</div>

<div class="container">
    <div class="card">
        <h3>1. LOG ENTRY</h3>
        <div class="input-group">
            <input type="text" id="stuName" placeholder="FULL NAME">
            <input type="text" id="stuClass" placeholder="CLASS">
            <select id="violation">
                <option value="" disabled selected>OFFENCE TYPE</option>
                <option value="Late">LATE</option>
                <option value="Skipping Class">SKIPPING CLASS</option>
                <option value="Bullying">BULLYING</option>
                <option value="Discrimination">DISCRIMINATION</option>
                <option value="Contraband">CONTRABAND</option>
                <option value="Severe Misconduct/Drugs">DRUGS/SEVERE</option>
                <option value="Others">OTHERS</option>
            </select>
            <button onclick="submitRecord()">Commit</button>
        </div>
    </div>

    <div class="card" style="background: transparent; border: none; padding: 0;">
        <h3>2. RECORDS</h3>
        <input type="text" id="searchBox" onkeyup="handleSearch()" placeholder="Search Name or Class...">
        <table>
            <thead>
                <tr><th width="25%">Identity</th><th width="45%">History</th><th width="15%" style="text-align:center">Total</th><th width="15%">Action</th></tr>
            </thead>
            <tbody id="recordBody"></tbody>
        </table>
        <div style="display:flex; justify-content:space-between; padding:15px; background:#111; border-radius:12px;">
            <button onclick="changePage(-1)" id="prevBtn" style="padding:5px 15px; font-size:10px;">PREV</button>
            <span id="pageDisplay" style="font-size:12px; color:#666;">PAGE 1</span>
            <button onclick="changePage(1)" id="nextBtn" style="padding:5px 15px; font-size:10px;">NEXT</button>
        </div>
    </div>

    <div class="action-bar">
        <input type="date" id="reportDate" style="background:#111; color:white; border:1px solid #444; padding:10px; border-radius:6px;">
        <button class="report-btn" onclick="downloadReport()">Download PNG Report</button>
        <button class="master-btn" onclick="masterSystemReset()">Annual Reset</button>
    </div>
</div>

<div id="reportExportTemplate">
    <h1 style="text-align:center; border-bottom: 4px double #000; padding-bottom:10px;">SEMSIRA BDP DISCIPLINE REPORT</h1>
    <div style="display:flex; justify-content:space-between; margin: 20px 0; font-weight:bold;">
        <span id="rptDateSpan"></span><span id="rptAdminSpan"></span>
    </div>
    <table class="rpt-table">
        <thead><tr><th>Name</th><th>Class</th><th>Offence</th><th>Time</th><th>Recorder</th></tr></thead>
        <tbody id="reportTbody"></tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, where, getDocs, increment, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqY9ADs8oy1Uvh3-7eVCQLYfyTijm8lo4",
        authDomain: "bdpsemsira-5c274.firebaseapp.com",
        projectId: "bdpsemsira-5c274",
        storageBucket: "bdpsemsira-5c274.firebasestorage.app",
        messagingSenderId: "176946808975",
        appId: "1:176946808975:web:ef7447a11bb57fe71b88fa"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "students");

    const currentAdmin = sessionStorage.getItem('admin_name') || "OFFLINE";
    document.getElementById('displayAdmin').innerText = currentAdmin;
    document.getElementById('reportDate').valueAsDate = new Date();

    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    const pageSize = 15;

    onSnapshot(colRef, (snap) => {
        allData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        window.handleSearch();
    });

    window.handleSearch = () => {
        const term = document.getElementById('searchBox').value.toUpperCase();
        filteredData = allData.filter(s => s.name.includes(term) || s.class.includes(term));
        currentPage = 1; render();
    };

    window.changePage = (n) => { currentPage += n; render(); };

    function render() {
        const total = Math.ceil(filteredData.length / pageSize) || 1;
        const start = (currentPage - 1) * pageSize;
        const pageItems = filteredData.slice(start, start + pageSize);
        document.getElementById('pageDisplay').innerText = `PAGE ${currentPage} OF ${total}`;

        let html = "";
        pageItems.forEach(s => {
            html += `<tr>
                <td><b>${s.name}</b><br><small style="color:var(--accent)">${s.class}</small></td>
                <td>${s.offences.map(o => `<span class="offence-tag">${o.type}</span>`).join('')}</td>
                <td style="text-align:center"><span class="count-badge">${s.counts}</span></td>
                <td><button class="delete-btn" onclick="purge('${s.id}')">Purge</button></td>
            </tr>`;
        });
        document.getElementById('recordBody').innerHTML = html || '<tr><td colspan="4">No Records</td></tr>';
    }

    window.submitRecord = async () => {
        const name = document.getElementById('stuName').value.trim().toUpperCase();
        const cls = document.getElementById('stuClass').value.trim().toUpperCase();
        const type = document.getElementById('violation').value;
        if(!name || !cls || !type) return alert("Fill all!");

        const log = { type, time: new Date().toLocaleString('en-GB'), by: currentAdmin };
        const q = query(colRef, where("name", "==", name), where("class", "==", cls));
        const qs = await getDocs(q);

        if(!qs.empty) {
            await updateDoc(doc(db, "students", qs.docs[0].id), { offences: [...qs.docs[0].data().offences, log], counts: increment(1) });
        } else {
            await addDoc(colRef, { name, class: cls, offences: [log], counts: 1 });
        }
        document.getElementById('stuName').value = "";
    };

    window.downloadReport = async () => {
        const dateInput = document.getElementById('reportDate').value;
        const [y, m, d] = dateInput.split('-');
        const target = `${d}/${m}/${y}`;
        const tbody = document.getElementById('reportTbody');
        tbody.innerHTML = "";
        
        let reportMap = new Map(); // 用于合并同一个人同一天的多次错误

        allData.forEach(stu => {
            stu.offences.forEach(off => {
                if (off.time.includes(target)) {
                    const key = `${stu.name}_${stu.class}_${off.type}`;
                    if(reportMap.has(key)) {
                        let existing = reportMap.get(key);
                        existing.count += 1;
                    } else {
                        reportMap.set(key, { name: stu.name, class: stu.class, type: off.type, time: off.time.split(', ')[1], by: off.by, count: 1 });
                    }
                }
            });
        });

        if(reportMap.size === 0) return alert("No cases.");
        
        reportMap.forEach(item => {
            let cName = "c-bad";
            if(item.type.includes("Late")) cName = "c-late";
            else if(item.type.includes("Skip")) cName = "c-skip";
            else if(item.type.includes("Contraband")) cName = "c-contraband";
            else if(item.type.includes("Severe")) cName = "c-drug";

            tbody.innerHTML += `<tr>
                <td style="text-align:left; font-weight:bold;">${item.name}</td>
                <td>${item.class}</td>
                <td class="${cName}">${item.type} ${item.count > 1 ? 'x'+item.count : ''}</td>
                <td>${item.time}</td>
                <td>${item.by}</td>
            </tr>`;
        });

        document.getElementById('rptDateSpan').innerText = "DATE: " + target;
        document.getElementById('rptAdminSpan').innerText = "OPERATOR: " + currentAdmin;
        
        html2canvas(document.getElementById('reportExportTemplate'), { backgroundColor: "#fff", scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `BDP_Report_${target}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    };

    window.purge = async (id) => { if(confirm("Delete student?")) await deleteDoc(doc(db, "students", id)); };
    window.masterSystemReset = async () => {
        if(confirm("WIPE ALL DATA?") && prompt("Code:") === "RESET2026") {
            const qs = await getDocs(colRef);
            const batch = writeBatch(db);
            qs.forEach(d => batch.delete(d.ref));
            await batch.commit();
            alert("Cleared");
        }
    };
</script>
</body>
</html>
